CodeMirror.Vim.suppressErrorLogging=true;var code=" wOrd1 (#%\n word3] \naopop pop 0 1 2 3 4\n (a) [b] {c} \nint getchar(void) {\n  static char buf[BUFSIZ];\n  static char *bufp = buf;\n  if (n == 0) {  /* buffer is empty */\n    n = read(0, buf, sizeof buf);\n    bufp = buf;\n  }\n\n  return (--n >= 0) ? (unsigned char) *bufp++ : EOF;\n \n}\n";var lines=(function(){lineText=code.split("\n");var a=[];for(var b=0;b<lineText.length;b++){a[b]={line:b,length:lineText[b].length,lineText:lineText[b],textStart:/^\s*/.exec(lineText[b])[0].length}}return a})();var endOfDocument=makeCursor(lines.length-1,lines[lines.length-1].length);var wordLine=lines[0];var bigWordLine=lines[1];var charLine=lines[2];var bracesLine=lines[3];var seekBraceLine=lines[4];var word1={start:{line:wordLine.line,ch:1},end:{line:wordLine.line,ch:5}};var word2={start:{line:wordLine.line,ch:word1.end.ch+2},end:{line:wordLine.line,ch:word1.end.ch+4}};var word3={start:{line:bigWordLine.line,ch:1},end:{line:bigWordLine.line,ch:5}};var bigWord1=word1;var bigWord2=word2;var bigWord3={start:{line:bigWordLine.line,ch:1},end:{line:bigWordLine.line,ch:7}};var bigWord4={start:{line:bigWordLine.line,ch:bigWord1.end.ch+3},end:{line:bigWordLine.line,ch:bigWord1.end.ch+7}};var oChars=[{line:charLine.line,ch:1},{line:charLine.line,ch:3},{line:charLine.line,ch:7}];var pChars=[{line:charLine.line,ch:2},{line:charLine.line,ch:4},{line:charLine.line,ch:6},{line:charLine.line,ch:8}];var numChars=[{line:charLine.line,ch:10},{line:charLine.line,ch:12},{line:charLine.line,ch:14},{line:charLine.line,ch:16},{line:charLine.line,ch:18}];var parens1={start:{line:bracesLine.line,ch:1},end:{line:bracesLine.line,ch:3}};var squares1={start:{line:bracesLine.line,ch:5},end:{line:bracesLine.line,ch:7}};var curlys1={start:{line:bracesLine.line,ch:9},end:{line:bracesLine.line,ch:11}};var seekOutside={start:{line:seekBraceLine.line,ch:1},end:{line:seekBraceLine.line,ch:16}};var seekInside={start:{line:seekBraceLine.line,ch:14},end:{line:seekBraceLine.line,ch:11}};function copyCursor(a){return{ch:a.ch,line:a.line}}function forEach(a,c){for(var b=0;b<a.length;b++){c(a[b],b,a)}}function testVim(b,e,c,a){var d={lineNumbers:true,vimMode:true,showCursorWhenSelecting:true,value:code};for(var f in c){if(c.hasOwnProperty(f)){d[f]=c[f]}}return test("vim_"+b,function(){var i=document.getElementById("testground");var p=CodeMirror(i,d);var j=CodeMirror.Vim.maybeInitVimState_(p);function q(t){return function(u){if(u instanceof Array){arguments=u}for(var v=0;v<arguments.length;v++){CodeMirror.Vim.handleKey(t,arguments[v])}}}function m(t){return function(v){if(v instanceof Array){arguments=v}function u(A){if(typeof A=="string"){CodeMirror.commands[A](t)}else{A(t)}return true}for(var x=0;x<arguments.length;x++){var w=arguments[x];var z=CodeMirror.lookupKey(w,"vim-insert",u);if(z=="handled"&&t.state.vim.insertMode&&arguments[x]!="Esc"){var y=CodeMirror.Vim.getVimGlobalState_().macroModeState.lastInsertModeChanges;if(y){y.changes.push(new CodeMirror.Vim.InsertModeKey(w))}}}}}function r(t){return function(u){t.openDialog=g.fakeOpenDialog(u);g.doKeys(":")}}function h(t){return function(u,v){var w;if(v==null&&typeof u.line=="number"){w=u}else{w=makeCursor(u,v)}eqPos(w,t.getCursor())}}function s(t){return function(u,v){return v(t)}}function l(t){return function(u){t(u)}}var g={doKeys:q(p),doInsertModeKeys:m(p),doEx:r(p),assertCursorAt:h(p),fakeOpenDialog:s,fakeOpenNotification:l,getRegisterController:function(){return CodeMirror.Vim.getRegisterController()}};CodeMirror.Vim.resetVimGlobalState_();var k=false;var n=p.openNotification;var o=p.openDialog;try{e(p,j,g);k=true}finally{p.openNotification=n;p.openDialog=o;if(!k||verbose){i.style.visibility="visible"}else{i.removeChild(p.getWrapperElement())}}},a)}testVim("qq@q",function(a,b,c){a.setCursor(0,0);c.doKeys("q","q","l","l","q");c.assertCursorAt(0,2);c.doKeys("@","q");c.assertCursorAt(0,4)},{value:"            "});testVim("@@",function(a,b,c){a.setCursor(0,0);c.doKeys("q","q","l","l","q");c.assertCursorAt(0,2);c.doKeys("@","q");c.assertCursorAt(0,4);c.doKeys("@","@");c.assertCursorAt(0,6)},{value:"            "});var jumplistScene="word\n(word)\n{word\nword.\n\nword search\n}word\nword\nword\n";function testJumplist(c,e,b,a,d){b=makeCursor(b[0],b[1]);a=makeCursor(a[0],a[1]);testVim(c,function(f,g,h){CodeMirror.Vim.resetVimGlobalState_();if(d){f.openDialog=h.fakeOpenDialog("word")}f.setCursor(a);h.doKeys.apply(null,e);h.assertCursorAt(b)},{value:jumplistScene})}testJumplist("jumplist_H",["H","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_M",["M","<C-o>"],[2,2],[2,2]);testJumplist("jumplist_L",["L","<C-o>"],[2,2],[2,2]);testJumplist("jumplist_[[",["[","[","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_]]",["]","]","<C-o>"],[2,2],[2,2]);testJumplist("jumplist_G",["G","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_gg",["g","g","<C-o>"],[5,2],[5,2]);testJumplist("jumplist_%",["%","<C-o>"],[1,5],[1,5]);testJumplist("jumplist_{",["{","<C-o>"],[1,5],[1,5]);testJumplist("jumplist_}",["}","<C-o>"],[1,5],[1,5]);testJumplist("jumplist_'",["m","a","h","'","a","h","<C-i>"],[1,0],[1,5]);testJumplist("jumplist_`",["m","a","h","`","a","h","<C-i>"],[1,5],[1,5]);testJumplist("jumplist_*_cachedCursor",["*","<C-o>"],[1,3],[1,3]);testJumplist("jumplist_#_cachedCursor",["#","<C-o>"],[1,3],[1,3]);testJumplist("jumplist_n",["#","n","<C-o>"],[1,1],[2,3]);testJumplist("jumplist_N",["#","N","<C-o>"],[1,1],[2,3]);testJumplist("jumplist_repeat_<c-o>",["*","*","*","3","<C-o>"],[2,3],[2,3]);testJumplist("jumplist_repeat_<c-i>",["*","*","*","3","<C-o>","2","<C-i>"],[5,0],[2,3]);testJumplist("jumplist_repeated_motion",["3","*","<C-o>"],[2,3],[2,3]);testJumplist("jumplist_/",["/","<C-o>"],[2,3],[2,3],"dialog");testJumplist("jumplist_?",["?","<C-o>"],[2,3],[2,3],"dialog");testJumplist("jumplist_skip_delted_mark<c-o>",["*","n","n","k","d","k","<C-o>","<C-o>","<C-o>"],[0,2],[0,2]);testJumplist("jumplist_skip_delted_mark<c-i>",["*","n","n","k","d","k","<C-o>","<C-i>","<C-i>"],[1,0],[0,2]);function testMotion(c,d,b,a){testVim(c,function(e,f,g){if(!a){a={line:0,ch:0}}e.setCursor(a);g.doKeys(d);g.assertCursorAt(b)})}function makeCursor(a,b){return{line:a,ch:b}}function offsetCursor(b,a,c){return{line:b.line+a,ch:b.ch+c}}testMotion("|","|",makeCursor(0,0),makeCursor(0,4));testMotion("|_repeat",["3","|"],makeCursor(0,2),makeCursor(0,4));testMotion("h","h",makeCursor(0,0),word1.start);testMotion("h_repeat",["3","h"],offsetCursor(word1.end,0,-3),word1.end);testMotion("l","l",makeCursor(0,1));testMotion("l_repeat",["2","l"],makeCursor(0,2));testMotion("j","j",offsetCursor(word1.end,1,0),word1.end);testMotion("j_repeat",["2","j"],offsetCursor(word1.end,2,0),word1.end);testMotion("j_repeat_clip",["1000","j"],endOfDocument);testMotion("k","k",offsetCursor(word3.end,-1,0),word3.end);testMotion("k_repeat",["2","k"],makeCursor(0,4),makeCursor(2,4));testMotion("k_repeat_clip",["1000","k"],makeCursor(0,4),makeCursor(2,4));testMotion("w","w",word1.start);testMotion("w_multiple_newlines_no_space","w",makeCursor(12,2),makeCursor(11,2));testMotion("w_multiple_newlines_with_space","w",makeCursor(14,0),makeCursor(12,51));testMotion("w_repeat",["2","w"],word2.start);testMotion("w_wrap",["w"],word3.start,word2.start);testMotion("w_endOfDocument","w",endOfDocument,endOfDocument);testMotion("w_start_to_end",["1000","w"],endOfDocument,makeCursor(0,0));testMotion("W","W",bigWord1.start);testMotion("W_repeat",["2","W"],bigWord3.start,bigWord1.start);testMotion("e","e",word1.end);testMotion("e_repeat",["2","e"],word2.end);testMotion("e_wrap","e",word3.end,word2.end);testMotion("e_endOfDocument","e",endOfDocument,endOfDocument);testMotion("e_start_to_end",["1000","e"],endOfDocument,makeCursor(0,0));testMotion("b","b",word3.start,word3.end);testMotion("b_repeat",["2","b"],word2.start,word3.end);testMotion("b_wrap","b",word2.start,word3.start);testMotion("b_startOfDocument","b",makeCursor(0,0),makeCursor(0,0));testMotion("b_end_to_start",["1000","b"],makeCursor(0,0),endOfDocument);testMotion("ge",["g","e"],word2.end,word3.end);testMotion("ge_repeat",["2","g","e"],word1.end,word3.start);testMotion("ge_wrap",["g","e"],word2.end,word3.start);testMotion("ge_startOfDocument",["g","e"],makeCursor(0,0),makeCursor(0,0));testMotion("ge_end_to_start",["1000","g","e"],makeCursor(0,0),endOfDocument);testMotion("gg",["g","g"],makeCursor(lines[0].line,lines[0].textStart),makeCursor(3,1));testMotion("gg_repeat",["3","g","g"],makeCursor(lines[2].line,lines[2].textStart));testMotion("G","G",makeCursor(lines[lines.length-1].line,lines[lines.length-1].textStart),makeCursor(3,1));testMotion("G_repeat",["3","G"],makeCursor(lines[2].line,lines[2].textStart));testMotion("0","0",makeCursor(0,0),makeCursor(0,8));testMotion("^","^",makeCursor(0,lines[0].textStart),makeCursor(0,8));testMotion("+","+",makeCursor(1,lines[1].textStart),makeCursor(0,8));testMotion("-","-",makeCursor(0,lines[0].textStart),makeCursor(1,4));testMotion("_",["6","_"],makeCursor(5,lines[5].textStart),makeCursor(0,8));testMotion("$","$",makeCursor(0,lines[0].length-1),makeCursor(0,1));testMotion("$_repeat",["2","$"],makeCursor(1,lines[1].length-1),makeCursor(0,3));testMotion("f",["f","p"],pChars[0],makeCursor(charLine.line,0));testMotion("f_repeat",["2","f","p"],pChars[2],pChars[0]);testMotion("f_num",["f","2"],numChars[2],makeCursor(charLine.line,0));testMotion("t",["t","p"],offsetCursor(pChars[0],0,-1),makeCursor(charLine.line,0));testMotion("t_repeat",["2","t","p"],offsetCursor(pChars[2],0,-1),pChars[0]);testMotion("F",["F","p"],pChars[0],pChars[1]);testMotion("F_repeat",["2","F","p"],pChars[0],pChars[2]);testMotion("T",["T","p"],offsetCursor(pChars[0],0,1),pChars[1]);testMotion("T_repeat",["2","T","p"],offsetCursor(pChars[0],0,1),pChars[2]);testMotion("%_parens",["%"],parens1.end,parens1.start);testMotion("%_squares",["%"],squares1.end,squares1.start);testMotion("%_braces",["%"],curlys1.end,curlys1.start);testMotion("%_seek_outside",["%"],seekOutside.end,seekOutside.start);testMotion("%_seek_inside",["%"],seekInside.end,seekInside.start);testVim("%_seek_skip",function(a,b,c){a.setCursor(0,0);c.doKeys(["%"]);c.assertCursorAt(0,9)},{value:'01234"("()'});testVim("%_skip_string",function(a,b,c){a.setCursor(0,0);c.doKeys(["%"]);c.assertCursorAt(0,4);a.setCursor(0,2);c.doKeys(["%"]);c.assertCursorAt(0,0)},{value:'(")")'});testVim("%_skip_comment",function(a,b,c){a.setCursor(0,0);c.doKeys(["%"]);c.assertCursorAt(0,6);a.setCursor(0,3);c.doKeys(["%"]);c.assertCursorAt(0,0)},{value:"(/*)*/)"});testVim("Changing lines after Eol operation",function(a,b,c){a.setCursor(0,0);c.doKeys(["$"]);c.doKeys(["j"]);c.assertCursorAt({line:1,ch:lines[1].length-1});c.doKeys(["j"]);c.assertCursorAt({line:2,ch:lines[2].length-1});c.doKeys(["h"]);c.doKeys(["j"]);c.assertCursorAt({line:3,ch:lines[3].length-1});c.doKeys(["j"]);c.doKeys(["j"]);c.assertCursorAt({line:5,ch:lines[2].length-2})});testVim("gj_gk_clipping",function(a,b,c){a.setCursor(0,1);c.doKeys("g","j","g","j");c.assertCursorAt(2,1);c.doKeys("g","k","g","k");c.assertCursorAt(0,1)},{value:"line 1\n\nline 2"});testVim("j_k_and_gj_gk",function(a,b,c){a.setSize(120);a.setCursor(0,0);c.doKeys("$");c.doKeys("g","k");var d=a.getCursor();eq(d.line,0);is((d.ch<176),"gk didn't move cursor back (1)");c.doKeys("g","j");c.assertCursorAt(0,176);c.doKeys("j");c.doKeys("3","g","k");d=a.getCursor();eq(d.line,1);is((d.ch<176),"gk didn't move cursor back (2)");c.doKeys("g","j","2","g","j");c.doKeys("k");c.assertCursorAt(0,176)},{lineWrapping:true,value:"This line is intentially long to test movement of gj and gk over wrapped lines. I will start on the end of this line, then make a step up and back to set the origin for j and k.\nThis line is supposed to be even longer than the previous. I will jump here and make another wiggle with gj and gk, before I jump back to the line above. Both wiggles should not change my cursor's target character but both j/k and gj/gk change each other's reference position."});testVim("gj_gk",function(a,b,e){if(phantom){return}a.setSize(120);a.setCursor(0,4);e.doKeys("g","j");e.doKeys("10","g","k");e.assertCursorAt(0,4);e.doKeys("g","j");var d=a.getCursor();var c={line:0,ch:(d.ch-4)*2+4};e.doKeys("g","j");e.assertCursorAt(c);a.setCursor(0,0);e.doKeys("h");e.doKeys("100","g","j");var h=a.getCursor();is(h!=0,"gj should not be on wrapped line 0");var g=a.charCoords(makeCursor(0,0));var f=a.charCoords(h);is(g.left==f.left,"gj should end up on column 0")},{lineNumbers:false,lineWrapping:true,value:"Thislineisintentiallylongtotestmovementofgjandgkoverwrappedlines."});testVim("}",function(a,b,c){a.setCursor(0,0);c.doKeys("}");c.assertCursorAt(1,0);a.setCursor(0,0);c.doKeys("2","}");c.assertCursorAt(4,0);a.setCursor(0,0);c.doKeys("6","}");c.assertCursorAt(5,0)},{value:"a\n\nb\nc\n\nd"});testVim("{",function(a,b,c){a.setCursor(5,0);c.doKeys("{");c.assertCursorAt(4,0);a.setCursor(5,0);c.doKeys("2","{");c.assertCursorAt(1,0);a.setCursor(5,0);c.doKeys("6","{");c.assertCursorAt(0,0)},{value:"a\n\nb\nc\n\nd"});testVim("paragraph_motions",function(a,b,d){a.setCursor(10,0);d.doKeys("{");d.assertCursorAt(4,0);d.doKeys("{");d.assertCursorAt(0,0);d.doKeys("2","}");d.assertCursorAt(7,0);d.doKeys("2","}");d.assertCursorAt(16,0);a.setCursor(9,0);d.doKeys("}");d.assertCursorAt(14,0);a.setCursor(6,0);d.doKeys("}");d.assertCursorAt(7,0);a.setCursor(10,0);d.doKeys("v","i","p");eqPos(Pos(7,0),a.getCursor("anchor"));eqPos(Pos(12,0),a.getCursor("head"));d.doKeys("i","p");eqPos(Pos(7,0),a.getCursor("anchor"));eqPos(Pos(13,1),a.getCursor("head"));d.doKeys("2","i","p");eqPos(Pos(7,0),a.getCursor("anchor"));eqPos(Pos(16,1),a.getCursor("head"));a.setCursor(14,0);d.doKeys("<Esc>","v","i","p");d.assertCursorAt(14,0);a.setCursor(14,0);d.doKeys("<Esc>","V","i","p");eqPos(Pos(16,1),a.getCursor("head"));a.setCursor(10,0);d.doKeys("<Esc>","v","a","p");eqPos(Pos(7,0),a.getCursor("anchor"));eqPos(Pos(13,1),a.getCursor("head"));d.doKeys("a","p");eqPos(Pos(7,0),a.getCursor("anchor"));eqPos(Pos(16,1),a.getCursor("head"));a.setCursor(13,0);d.doKeys("v","a","p");eqPos(Pos(13,0),a.getCursor("anchor"));eqPos(Pos(14,0),a.getCursor("head"));a.setCursor(16,0);d.doKeys("v","a","p");eqPos(Pos(14,0),a.getCursor("anchor"));eqPos(Pos(16,1),a.getCursor("head"));a.setCursor(0,0);d.doKeys("v","a","p");eqPos(Pos(0,0),a.getCursor("anchor"));eqPos(Pos(4,0),a.getCursor("head"));a.setCursor(0,0);d.doKeys("d","i","p");var c=d.getRegisterController().getRegister();eq("a\na\n",c.toString());is(c.linewise);d.doKeys("3","j","p");d.doKeys("y","i","p");is(c.linewise);eq("b\na\na\nc\n",c.toString())},{value:"a\na\n\n\n\nb\nc\n\n\n\n\n\n\nd\n\ne\nf"});testVim("dl",function(b,c,e){var a=makeCursor(0,0);b.setCursor(a);e.doKeys("d","l");eq("word1 ",b.getValue());var d=e.getRegisterController().getRegister();eq(" ",d.toString());is(!d.linewise);eqPos(a,b.getCursor())},{value:" word1 "});testVim("dl_eol",function(a,b,d){a.setCursor(0,6);d.doKeys("d","l");eq(" word1",a.getValue());var c=d.getRegisterController().getRegister();eq(" ",c.toString());is(!c.linewise);d.assertCursorAt(0,5)},{value:" word1 "});testVim("dl_repeat",function(b,c,e){var a=makeCursor(0,0);b.setCursor(a);e.doKeys("2","d","l");eq("ord1 ",b.getValue());var d=e.getRegisterController().getRegister();eq(" w",d.toString());is(!d.linewise);eqPos(a,b.getCursor())},{value:" word1 "});testVim("dh",function(b,c,e){var a=makeCursor(0,3);b.setCursor(a);e.doKeys("d","h");eq(" wrd1 ",b.getValue());var d=e.getRegisterController().getRegister();eq("o",d.toString());is(!d.linewise);eqPos(offsetCursor(a,0,-1),b.getCursor())},{value:" word1 "});testVim("dj",function(b,c,e){var a=makeCursor(0,3);b.setCursor(a);e.doKeys("d","j");eq(" word3",b.getValue());var d=e.getRegisterController().getRegister();eq(" word1\nword2\n",d.toString());is(d.linewise);e.assertCursorAt(0,1)},{value:" word1\nword2\n word3"});testVim("dj_end_of_document",function(b,c,e){var a=makeCursor(0,3);b.setCursor(a);e.doKeys("d","j");eq(" word1 ",b.getValue());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise);e.assertCursorAt(0,3)},{value:" word1 "});testVim("dk",function(b,c,e){var a=makeCursor(1,3);b.setCursor(a);e.doKeys("d","k");eq(" word3",b.getValue());var d=e.getRegisterController().getRegister();eq(" word1\nword2\n",d.toString());is(d.linewise);e.assertCursorAt(0,1)},{value:" word1\nword2\n word3"});testVim("dk_start_of_document",function(b,c,e){var a=makeCursor(0,3);b.setCursor(a);e.doKeys("d","k");eq(" word1 ",b.getValue());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise);e.assertCursorAt(0,3)},{value:" word1 "});testVim("dw_space",function(b,c,e){var a=makeCursor(0,0);b.setCursor(a);e.doKeys("d","w");eq("word1 ",b.getValue());var d=e.getRegisterController().getRegister();eq(" ",d.toString());is(!d.linewise);eqPos(a,b.getCursor())},{value:" word1 "});testVim("dw_word",function(b,c,e){var a=makeCursor(0,1);b.setCursor(a);e.doKeys("d","w");eq(" word2",b.getValue());var d=e.getRegisterController().getRegister();eq("word1 ",d.toString());is(!d.linewise);eqPos(a,b.getCursor())},{value:" word1 word2"});testVim("dw_unicode_word",function(a,b,c){c.doKeys("d","w");eq(a.getValue().length,10);c.doKeys("d","w");eq(a.getValue().length,6);c.doKeys("d","w");eq(a.getValue().length,5);c.doKeys("d","e");eq(a.getValue().length,2)},{value:"  \u0562\u0561\u0580\u0587\xbbe\xb5g  "});testVim("dw_only_word",function(a,b,d){a.setCursor(0,1);d.doKeys("d","w");eq(" ",a.getValue());var c=d.getRegisterController().getRegister();eq("word1 ",c.toString());is(!c.linewise);d.assertCursorAt(0,0)},{value:" word1 "});testVim("dw_eol",function(a,b,d){a.setCursor(0,1);d.doKeys("d","w");eq(" \nword2",a.getValue());var c=d.getRegisterController().getRegister();eq("word1",c.toString());is(!c.linewise);d.assertCursorAt(0,0)},{value:" word1\nword2"});testVim("dw_eol_with_multiple_newlines",function(a,b,d){a.setCursor(0,1);d.doKeys("d","w");eq(" \n\nword2",a.getValue());var c=d.getRegisterController().getRegister();eq("word1",c.toString());is(!c.linewise);d.assertCursorAt(0,0)},{value:" word1\n\nword2"});testVim("dw_empty_line_followed_by_whitespace",function(a,b,c){a.setCursor(0,0);c.doKeys("d","w");eq("  \nword",a.getValue())},{value:"\n  \nword"});testVim("dw_empty_line_followed_by_word",function(a,b,c){a.setCursor(0,0);c.doKeys("d","w");eq("word",a.getValue())},{value:"\nword"});testVim("dw_empty_line_followed_by_empty_line",function(a,b,c){a.setCursor(0,0);c.doKeys("d","w");eq("\n",a.getValue())},{value:"\n\n"});testVim("dw_whitespace_followed_by_whitespace",function(a,b,c){a.setCursor(0,0);c.doKeys("d","w");eq("\n   \n",a.getValue())},{value:"  \n   \n"});testVim("dw_whitespace_followed_by_empty_line",function(a,b,c){a.setCursor(0,0);c.doKeys("d","w");eq("\n\n",a.getValue())},{value:"  \n\n"});testVim("dw_word_whitespace_word",function(a,b,c){a.setCursor(0,0);c.doKeys("d","w");eq("\n   \nword2",a.getValue())},{value:"word1\n   \nword2"});testVim("dw_end_of_document",function(a,b,c){a.setCursor(1,2);c.doKeys("d","w");eq("\nab",a.getValue())},{value:"\nabc"});testVim("dw_repeat",function(a,b,d){a.setCursor(0,1);d.doKeys("d","2","w");eq(" ",a.getValue());var c=d.getRegisterController().getRegister();eq("word1\nword2",c.toString());is(!c.linewise);d.assertCursorAt(0,0)},{value:" word1\nword2"});testVim("de_word_start_and_empty_lines",function(a,b,c){a.setCursor(0,0);c.doKeys("d","e");eq("\n\n",a.getValue())},{value:"word\n\n"});testVim("de_word_end_and_empty_lines",function(a,b,c){a.setCursor(0,3);c.doKeys("d","e");eq("wor",a.getValue())},{value:"word\n\n\n"});testVim("de_whitespace_and_empty_lines",function(a,b,c){a.setCursor(0,0);c.doKeys("d","e");eq("",a.getValue())},{value:"   \n\n\n"});testVim("de_end_of_document",function(a,b,c){a.setCursor(1,2);c.doKeys("d","e");eq("\nab",a.getValue())},{value:"\nabc"});testVim("db_empty_lines",function(a,b,c){a.setCursor(2,0);c.doKeys("d","b");eq("\n\n",a.getValue())},{value:"\n\n\n"});testVim("db_word_start_and_empty_lines",function(a,b,c){a.setCursor(2,0);c.doKeys("d","b");eq("\nword",a.getValue())},{value:"\n\nword"});testVim("db_word_end_and_empty_lines",function(a,b,c){a.setCursor(2,3);c.doKeys("d","b");eq("\n\nd",a.getValue())},{value:"\n\nword"});testVim("db_whitespace_and_empty_lines",function(a,b,c){a.setCursor(2,0);c.doKeys("d","b");eq("",a.getValue())},{value:"\n   \n"});testVim("db_start_of_document",function(a,b,c){a.setCursor(0,0);c.doKeys("d","b");eq("abc\n",a.getValue())},{value:"abc\n"});testVim("dge_empty_lines",function(a,b,c){a.setCursor(1,0);c.doKeys("d","g","e");eq("\n",a.getValue())},{value:"\n\n"});testVim("dge_word_and_empty_lines",function(a,b,c){a.setCursor(1,0);c.doKeys("d","g","e");eq("wor\n",a.getValue())},{value:"word\n\n"});testVim("dge_whitespace_and_empty_lines",function(a,b,c){a.setCursor(2,0);c.doKeys("d","g","e");eq("",a.getValue())},{value:"\n  \n"});testVim("dge_start_of_document",function(a,b,c){a.setCursor(0,0);c.doKeys("d","g","e");eq("bc\n",a.getValue())},{value:"abc\n"});testVim("d_inclusive",function(b,c,e){var a=makeCursor(0,1);b.setCursor(a);e.doKeys("d","e");eq("  ",b.getValue());var d=e.getRegisterController().getRegister();eq("word1",d.toString());is(!d.linewise);eqPos(a,b.getCursor())},{value:" word1 "});testVim("d_reverse",function(a,b,d){a.setCursor(1,0);d.doKeys("d","b");eq(" word2 ",a.getValue());var c=d.getRegisterController().getRegister();eq("word1\n",c.toString());is(!c.linewise);d.assertCursorAt(0,1)},{value:" word1\nword2 "});testVim("dd",function(a,b,d){a.setCursor(0,3);var e=a.getRange({line:0,ch:0},{line:1,ch:0});var f=a.lineCount()-1;d.doKeys("d","d");eq(f,a.lineCount());var c=d.getRegisterController().getRegister();eq(e,c.toString());is(c.linewise);d.assertCursorAt(0,lines[1].textStart)});testVim("dd_prefix_repeat",function(a,b,d){a.setCursor(0,3);var e=a.getRange({line:0,ch:0},{line:2,ch:0});var f=a.lineCount()-2;d.doKeys("2","d","d");eq(f,a.lineCount());var c=d.getRegisterController().getRegister();eq(e,c.toString());is(c.linewise);d.assertCursorAt(0,lines[2].textStart)});testVim("dd_motion_repeat",function(a,b,d){a.setCursor(0,3);var e=a.getRange({line:0,ch:0},{line:2,ch:0});var f=a.lineCount()-2;d.doKeys("d","2","d");eq(f,a.lineCount());var c=d.getRegisterController().getRegister();eq(e,c.toString());is(c.linewise);d.assertCursorAt(0,lines[2].textStart)});testVim("dd_multiply_repeat",function(a,b,d){a.setCursor(0,3);var e=a.getRange({line:0,ch:0},{line:6,ch:0});var f=a.lineCount()-6;d.doKeys("2","d","3","d");eq(f,a.lineCount());var c=d.getRegisterController().getRegister();eq(e,c.toString());is(c.linewise);d.assertCursorAt(0,lines[6].textStart)});testVim("dd_lastline",function(a,b,c){a.setCursor(a.lineCount(),0);var d=a.lineCount()-1;c.doKeys("d","d");eq(d,a.lineCount());c.assertCursorAt(a.lineCount()-1,0)});testVim("dd_only_line",function(a,b,e){a.setCursor(0,0);var c=a.getValue()+"\n";e.doKeys("d","d");eq(1,a.lineCount());eq("",a.getValue());var d=e.getRegisterController().getRegister();eq(c,d.toString())},{value:"thisistheonlyline"});testVim("yw_repeat",function(b,c,e){var a=makeCursor(0,1);b.setCursor(a);e.doKeys("y","2","w");eq(" word1\nword2",b.getValue());var d=e.getRegisterController().getRegister();eq("word1\nword2",d.toString());is(!d.linewise);eqPos(a,b.getCursor())},{value:" word1\nword2"});testVim("yy_multiply_repeat",function(b,c,e){var a=makeCursor(0,3);b.setCursor(a);var f=b.getRange({line:0,ch:0},{line:6,ch:0});var g=b.lineCount();e.doKeys("2","y","3","y");eq(g,b.lineCount());var d=e.getRegisterController().getRegister();eq(f,d.toString());is(d.linewise);eqPos(a,b.getCursor())});testVim("cw",function(a,b,c){a.setCursor(0,0);c.doKeys("c","2","w");eq(" word3",a.getValue());c.assertCursorAt(0,0)},{value:"word1 word2 word3"});testVim("cw_repeat",function(b,c,e){var a=makeCursor(0,1);b.setCursor(a);e.doKeys("c","2","w");eq(" ",b.getValue());var d=e.getRegisterController().getRegister();eq("word1\nword2",d.toString());is(!d.linewise);eqPos(a,b.getCursor());eq("vim-insert",b.getOption("keyMap"))},{value:" word1\nword2"});testVim("cc_multiply_repeat",function(a,b,d){a.setCursor(0,3);var e=a.getRange({line:0,ch:0},{line:6,ch:0});var f=a.lineCount()-5;d.doKeys("2","c","3","c");eq(f,a.lineCount());var c=d.getRegisterController().getRegister();eq(e,c.toString());is(c.linewise);eq("vim-insert",a.getOption("keyMap"))});testVim("ct",function(a,b,c){a.setCursor(0,9);c.doKeys("c","t","w");eq("  word1  word3",a.getValue());c.doKeys("<Esc>","c","|");eq(" word3",a.getValue());c.assertCursorAt(0,0);c.doKeys("<Esc>","2","u","w","h");c.doKeys("c","2","g","e");eq("  wordword3",a.getValue())},{value:"  word1  word2  word3"});testVim("cc_should_not_append_to_document",function(a,b,c){var d=a.lineCount();a.setCursor(a.lastLine(),0);c.doKeys("c","c");eq(d,a.lineCount())});function fillArray(d,c){var a=[];for(var b=0;b<c;b++){a.push(d)}return a}testVim("c_visual_block",function(a,b,d){a.setCursor(0,1);d.doKeys("<C-v>","2","j","l","l","l","c");var c=fillArray("hello",3);a.replaceSelections(c);eq("1hello\n5hello\nahellofg",a.getValue());d.doKeys("<Esc>");a.setCursor(2,3);d.doKeys("<C-v>","2","k","h","C");c=fillArray("world",3);a.replaceSelections(c);eq("1hworld\n5hworld\nahworld",a.getValue())},{value:"1234\n5678\nabcdefg"});testVim("c_visual_block_replay",function(a,b,d){a.setCursor(0,1);d.doKeys("<C-v>","2","j","l","c");var c=fillArray("fo",3);a.replaceSelections(c);eq("1fo4\n5fo8\nafodefg",a.getValue());d.doKeys("<Esc>");a.setCursor(0,0);d.doKeys(".");eq("foo4\nfoo8\nfoodefg",a.getValue())},{value:"1234\n5678\nabcdefg"});testVim("d_visual_block",function(a,b,c){a.setCursor(0,1);c.doKeys("<C-v>","2","j","l","l","l","d");eq("1\n5\nafg",a.getValue())},{value:"1234\n5678\nabcdefg"});testVim("D_visual_block",function(a,b,c){a.setCursor(0,1);c.doKeys("<C-v>","2","j","l","D");eq("1\n5\na",a.getValue())},{value:"1234\n5678\nabcdefg"});testVim("g~w_repeat",function(b,c,e){var a=makeCursor(0,1);b.setCursor(a);e.doKeys("g","~","2","w");eq(" WORD1\nWORD2",b.getValue());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise);eqPos(a,b.getCursor())},{value:" word1\nword2"});testVim("g~g~",function(b,d,f){var a=makeCursor(0,3);b.setCursor(a);var g=b.lineCount();var c=b.getValue().toUpperCase();f.doKeys("2","g","~","3","g","~");eq(c,b.getValue());var e=f.getRegisterController().getRegister();eq("",e.toString());is(!e.linewise);eqPos(a,b.getCursor())},{value:" word1\nword2\nword3\nword4\nword5\nword6"});testVim("gu_and_gU",function(b,c,e){var a=makeCursor(0,7);var f=b.getValue();b.setCursor(a);e.doKeys("2","g","U","w");eq(b.getValue(),"wa wb xX WC wd");eqPos(a,b.getCursor());e.doKeys("2","g","u","w");eq(b.getValue(),f);e.doKeys("2","g","U","B");eq(b.getValue(),"wa WB Xx wc wd");eqPos(makeCursor(0,3),b.getCursor());b.setCursor(makeCursor(0,4));e.doKeys("g","u","i","w");eq(b.getValue(),"wa wb Xx wc wd");eqPos(makeCursor(0,3),b.getCursor());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise)},{value:"wa wb xx wc wd"});testVim("visual_block_~",function(a,b,c){a.setCursor(1,1);c.doKeys("<C-v>","l","l","j","~");c.assertCursorAt(1,1);eq("hello\nwoRLd\naBCDe",a.getValue());a.setCursor(2,0);c.doKeys("v","l","l","~");c.assertCursorAt(2,0);eq("hello\nwoRLd\nAbcDe",a.getValue())},{value:"hello\nwOrld\nabcde"});testVim("._swapCase_visualBlock",function(a,b,c){c.doKeys("<C-v>","j","j","l","~");a.setCursor(0,3);c.doKeys(".");eq("HelLO\nWorLd\nAbcdE",a.getValue())},{value:"hEllo\nwOrlD\naBcDe"});testVim("._delete_visualBlock",function(a,b,c){c.doKeys("<C-v>","j","x");eq("ive\ne\nsome\nsugar",a.getValue());c.doKeys(".");eq("ve\n\nsome\nsugar",a.getValue());c.doKeys("j","j",".");eq("ve\n\nome\nugar",a.getValue());c.doKeys("u","<C-r>",".");eq("ve\n\nme\ngar",a.getValue())},{value:"give\nme\nsome\nsugar"});testVim(">{motion}",function(a,c,e){a.setCursor(1,3);var f=a.lineCount();var b="   word1\n  word2\nword3 ";e.doKeys(">","k");eq(b,a.getValue());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise);e.assertCursorAt(0,3)},{value:" word1\nword2\nword3 ",indentUnit:2});testVim(">>",function(a,c,e){a.setCursor(0,3);var f=a.lineCount();var b="   word1\n  word2\nword3 ";e.doKeys("2",">",">");eq(b,a.getValue());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise);e.assertCursorAt(0,3)},{value:" word1\nword2\nword3 ",indentUnit:2});testVim("<{motion}",function(a,c,e){a.setCursor(1,3);var f=a.lineCount();var b=" word1\nword2\nword3 ";e.doKeys("<","k");eq(b,a.getValue());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise);e.assertCursorAt(0,1)},{value:"   word1\n  word2\nword3 ",indentUnit:2});testVim("<<",function(a,c,e){a.setCursor(0,3);var f=a.lineCount();var b=" word1\nword2\nword3 ";e.doKeys("2","<","<");eq(b,a.getValue());var d=e.getRegisterController().getRegister();eq("",d.toString());is(!d.linewise);e.assertCursorAt(0,1)},{value:"   word1\n  word2\nword3 ",indentUnit:2});function testEdit(a,c,e,b,d){return testVim(a,function(f,h,j){var i=c.search(e);var g=c.substring(0,i).split("\n").length-1;if(g){i=c.substring(0,i).split("\n").pop().length}f.setCursor(g,i);j.doKeys.apply(this,b.split(""));eq(d,f.getValue())},{value:c})}testEdit("diw_mid_spc","foo \tbAr\t baz",/A/,"diw","foo \t\t baz");testEdit("daw_mid_spc","foo \tbAr\t baz",/A/,"daw","foo \tbaz");testEdit("diw_mid_punct","foo \tbAr.\t baz",/A/,"diw","foo \t.\t baz");testEdit("daw_mid_punct","foo \tbAr.\t baz",/A/,"daw","foo.\t baz");testEdit("diw_mid_punct2","foo \t,bAr.\t baz",/A/,"diw","foo \t,.\t baz");testEdit("daw_mid_punct2","foo \t,bAr.\t baz",/A/,"daw","foo \t,.\t baz");testEdit("diw_start_spc","bAr \tbaz",/A/,"diw"," \tbaz");testEdit("daw_start_spc","bAr \tbaz",/A/,"daw","baz");testEdit("diw_start_punct","bAr. \tbaz",/A/,"diw",". \tbaz");testEdit("daw_start_punct","bAr. \tbaz",/A/,"daw",". \tbaz");testEdit("diw_end_spc","foo \tbAr",/A/,"diw","foo \t");testEdit("daw_end_spc","foo \tbAr",/A/,"daw","foo");testEdit("diw_end_punct","foo \tbAr.",/A/,"diw","foo \t.");testEdit("daw_end_punct","foo \tbAr.",/A/,"daw","foo.");testEdit("diW_mid_spc","foo \tbAr\t baz",/A/,"diW","foo \t\t baz");testEdit("daW_mid_spc","foo \tbAr\t baz",/A/,"daW","foo \tbaz");testEdit("diW_mid_punct","foo \tbAr.\t baz",/A/,"diW","foo \t\t baz");testEdit("daW_mid_punct","foo \tbAr.\t baz",/A/,"daW","foo \tbaz");testEdit("diW_mid_punct2","foo \t,bAr.\t baz",/A/,"diW","foo \t\t baz");testEdit("daW_mid_punct2","foo \t,bAr.\t baz",/A/,"daW","foo \tbaz");testEdit("diW_start_spc","bAr\t baz",/A/,"diW","\t baz");testEdit("daW_start_spc","bAr\t baz",/A/,"daW","baz");testEdit("diW_start_punct","bAr.\t baz",/A/,"diW","\t baz");testEdit("daW_start_punct","bAr.\t baz",/A/,"daW","baz");testEdit("diW_end_spc","foo \tbAr",/A/,"diW","foo \t");testEdit("daW_end_spc","foo \tbAr",/A/,"daW","foo");testEdit("diW_end_punct","foo \tbAr.",/A/,"diW","foo \t");testEdit("daW_end_punct","foo \tbAr.",/A/,"daW","foo");testEdit("di(_open_spc","foo (bAr) baz",/\(/,"di(","foo () baz");testEdit("di)_open_spc","foo (bAr) baz",/\(/,"di)","foo () baz");testEdit("dib_open_spc","foo (bAr) baz",/\(/,"dib","foo () baz");testEdit("da(_open_spc","foo (bAr) baz",/\(/,"da(","foo  baz");testEdit("da)_open_spc","foo (bAr) baz",/\(/,"da)","foo  baz");testEdit("di(_middle_spc","foo (bAr) baz",/A/,"di(","foo () baz");testEdit("di)_middle_spc","foo (bAr) baz",/A/,"di)","foo () baz");testEdit("da(_middle_spc","foo (bAr) baz",/A/,"da(","foo  baz");testEdit("da)_middle_spc","foo (bAr) baz",/A/,"da)","foo  baz");testEdit("di(_close_spc","foo (bAr) baz",/\)/,"di(","foo () baz");testEdit("di)_close_spc","foo (bAr) baz",/\)/,"di)","foo () baz");testEdit("da(_close_spc","foo (bAr) baz",/\)/,"da(","foo  baz");testEdit("da)_close_spc","foo (bAr) baz",/\)/,"da)","foo  baz");testEdit("dab_on_(_should_delete_around_()block","o( in(abc) )",/\(a/,"dab","o( in )");testEdit("daB_on_{_should_delete_around_{}block","o{ in{abc} }",/{a/,"daB","o{ in }");testEdit("diB_on_{_should_delete_inner_{}block","o{ in{abc} }",/{a/,"diB","o{ in{} }");testEdit("da{_on_{_should_delete_inner_block","o{ in{abc} }",/{a/,"da{","o{ in }");testEdit("di[_on_(_should_not_delete","foo (bAr) baz",/\(/,"di[","foo (bAr) baz");testEdit("di[_on_)_should_not_delete","foo (bAr) baz",/\)/,"di[","foo (bAr) baz");testEdit("da[_on_(_should_not_delete","foo (bAr) baz",/\(/,"da[","foo (bAr) baz");testEdit("da[_on_)_should_not_delete","foo (bAr) baz",/\)/,"da[","foo (bAr) baz");testMotion("di(_outside_should_stay",["d","i","("],{line:0,ch:0},{line:0,ch:0});testEdit("di{_middle_spc","a{\n\tbar\n}b",/r/,"di{","a{}b");testEdit("di}_middle_spc","a{\n\tbar\n}b",/r/,"di}","a{}b");testEdit("da{_middle_spc","a{\n\tbar\n}b",/r/,"da{","ab");testEdit("da}_middle_spc","a{\n\tbar\n}b",/r/,"da}","ab");testEdit("daB_middle_spc","a{\n\tbar\n}b",/r/,"daB","ab");testEdit("di{_middle_spc","a{\n\tbar\n\t}b",/r/,"di{","a{}b");testEdit("di}_middle_spc","a{\n\tbar\n\t}b",/r/,"di}","a{}b");testEdit("da{_middle_spc","a{\n\tbar\n\t}b",/r/,"da{","ab");testEdit("da}_middle_spc","a{\n\tbar\n\t}b",/r/,"da}","ab");testEdit("di[_middle_spc","a\t[\n\tbar\n]b",/r/,"di[","a\t[]b");testEdit("di]_middle_spc","a\t[\n\tbar\n]b",/r/,"di]","a\t[]b");testEdit("da[_middle_spc","a\t[\n\tbar\n]b",/r/,"da[","a\tb");testEdit("da]_middle_spc","a\t[\n\tbar\n]b",/r/,"da]","a\tb");function testSelection(a,d,e,b,c){return testVim(a,function(f,h,j){var i=d.search(e);var g=d.substring(0,i).split("\n").length-1;if(g){i=d.substring(0,i).split("\n").pop().length}f.setCursor(g,i);j.doKeys.apply(this,b.split(""));eq(c,f.getSelection())},{value:d})}testSelection("viw_middle_spc","foo \tbAr\t baz",/A/,"viw","bAr");testSelection("vaw_middle_spc","foo \tbAr\t baz",/A/,"vaw","bAr\t ");testSelection("viw_middle_punct","foo \tbAr,\t baz",/A/,"viw","bAr");testSelection("vaW_middle_punct","foo \tbAr,\t baz",/A/,"vaW","bAr,\t ");testSelection("viw_start_spc","foo \tbAr\t baz",/b/,"viw","bAr");testSelection("viw_end_spc","foo \tbAr\t baz",/r/,"viw","bAr");testSelection("viw_eol","foo \tbAr",/r/,"viw","bAr");testSelection("vi{_middle_spc","a{\n\tbar\n\t}b",/r/,"vi{","\n\tbar\n\t");testSelection("va{_middle_spc","a{\n\tbar\n\t}b",/r/,"va{","{\n\tbar\n\t}");testVim("mouse_select",function(a,b,c){a.setSelection(Pos(0,2),Pos(0,4),{origin:"*mouse"});is(a.state.vim.visualMode);is(!a.state.vim.visualLine);is(!a.state.vim.visualBlock);c.doKeys("<Esc>");is(!a.somethingSelected());c.doKeys("g","v");eq("cd",a.getSelection())},{value:"abcdef"});testVim("D",function(a,b,d){a.setCursor(0,3);d.doKeys("D");eq(" wo\nword2\n word3",a.getValue());var c=d.getRegisterController().getRegister();eq("rd1",c.toString());is(!c.linewise);d.assertCursorAt(0,2)},{value:" word1\nword2\n word3"});testVim("C",function(b,c,e){var a=makeCursor(0,3);b.setCursor(a);e.doKeys("C");eq(" wo\nword2\n word3",b.getValue());var d=e.getRegisterController().getRegister();eq("rd1",d.toString());is(!d.linewise);eqPos(a,b.getCursor());eq("vim-insert",b.getOption("keyMap"))},{value:" word1\nword2\n word3"});testVim("Y",function(b,c,e){var a=makeCursor(0,3);b.setCursor(a);e.doKeys("Y");eq(" word1\nword2\n word3",b.getValue());var d=e.getRegisterController().getRegister();eq("rd1",d.toString());is(!d.linewise);e.assertCursorAt(0,3)},{value:" word1\nword2\n word3"});testVim("~",function(a,b,c){c.doKeys("3","~");eq("ABCdefg",a.getValue());c.assertCursorAt(0,3)},{value:"abcdefg"});testVim("ctrl-a",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-a>");eq("-9",a.getValue());c.assertCursorAt(0,1);c.doKeys("2","<C-a>");eq("-7",a.getValue())},{value:"-10"});testVim("ctrl-x",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-x>");eq("-1",a.getValue());c.assertCursorAt(0,1);c.doKeys("2","<C-x>");eq("-3",a.getValue())},{value:"0"});testVim("<C-x>/<C-a> search forward",function(a,b,c){forEach(["<C-x>","<C-a>"],function(d){a.setCursor(0,0);c.doKeys(d);c.assertCursorAt(0,5);c.doKeys("l");c.doKeys(d);c.assertCursorAt(0,10);a.setCursor(0,11);c.doKeys(d);c.assertCursorAt(0,11)})},{value:"__jmp1 jmp2 jmp"});testVim("a",function(a,b,c){a.setCursor(0,1);c.doKeys("a");c.assertCursorAt(0,2);eq("vim-insert",a.getOption("keyMap"))});testVim("a_eol",function(a,b,c){a.setCursor(0,lines[0].length-1);c.doKeys("a");c.assertCursorAt(0,lines[0].length);eq("vim-insert",a.getOption("keyMap"))});testVim("A_endOfSelectedArea",function(a,b,c){a.setCursor(0,0);c.doKeys("v","j","l");c.doKeys("A");c.assertCursorAt(1,2);eq("vim-insert",a.getOption("keyMap"))},{value:"foo\nbar"});testVim("i",function(a,b,c){a.setCursor(0,1);c.doKeys("i");c.assertCursorAt(0,1);eq("vim-insert",a.getOption("keyMap"))});testVim("i_repeat",function(a,b,c){c.doKeys("3","i");a.replaceRange("test",a.getCursor());c.doKeys("<Esc>");eq("testtesttest",a.getValue());c.assertCursorAt(0,11)},{value:""});testVim("i_repeat_delete",function(a,b,c){a.setCursor(0,4);c.doKeys("2","i");a.replaceRange("z",a.getCursor());c.doInsertModeKeys("Backspace","Backspace");c.doKeys("<Esc>");eq("abe",a.getValue());c.assertCursorAt(0,1)},{value:"abcde"});testVim("A",function(a,b,c){c.doKeys("A");c.assertCursorAt(0,lines[0].length);eq("vim-insert",a.getOption("keyMap"))});testVim("A_visual_block",function(a,b,d){a.setCursor(0,1);d.doKeys("<C-v>","2","j","l","l","A");var c=new Array(a.listSelections().length+1).join("hello ").split(" ");c.pop();a.replaceSelections(c);eq("testhello\nmehello\npleahellose",a.getValue());d.doKeys("<Esc>");a.setCursor(0,0);d.doKeys(".")},{value:"test\nme\nplease"});testVim("I",function(a,b,c){a.setCursor(0,4);c.doKeys("I");c.assertCursorAt(0,lines[0].textStart);eq("vim-insert",a.getOption("keyMap"))});testVim("I_repeat",function(a,b,c){a.setCursor(0,1);c.doKeys("3","I");a.replaceRange("test",a.getCursor());c.doKeys("<Esc>");eq("testtesttestblah",a.getValue());c.assertCursorAt(0,11)},{value:"blah"});testVim("I_visual_block",function(a,b,d){a.setCursor(0,0);d.doKeys("<C-v>","2","j","l","l","I");var c=new Array(a.listSelections().length+1).join("hello ").split(" ");c.pop();a.replaceSelections(c);eq("hellotest\nhellome\nhelloplease",a.getValue())},{value:"test\nme\nplease"});testVim("o",function(a,b,c){a.setCursor(0,4);c.doKeys("o");eq("word1\n\nword2",a.getValue());c.assertCursorAt(1,0);eq("vim-insert",a.getOption("keyMap"))},{value:"word1\nword2"});testVim("o_repeat",function(a,b,c){a.setCursor(0,0);c.doKeys("3","o");a.replaceRange("test",a.getCursor());c.doKeys("<Esc>");eq("\ntest\ntest\ntest",a.getValue());c.assertCursorAt(3,3)},{value:""});testVim("O",function(a,b,c){a.setCursor(0,4);c.doKeys("O");eq("\nword1\nword2",a.getValue());c.assertCursorAt(0,0);eq("vim-insert",a.getOption("keyMap"))},{value:"word1\nword2"});testVim("J",function(a,c,d){a.setCursor(0,4);d.doKeys("J");var b="word1  word2\nword3\n word4";eq(b,a.getValue());d.assertCursorAt(0,b.indexOf("word2")-1)},{value:"word1 \n    word2\nword3\n word4"});testVim("J_repeat",function(a,c,d){a.setCursor(0,4);d.doKeys("3","J");var b="word1  word2 word3\n word4";eq(b,a.getValue());d.assertCursorAt(0,b.indexOf("word3")-1)},{value:"word1 \n    word2\nword3\n word4"});testVim("p",function(a,b,c){a.setCursor(0,1);c.getRegisterController().pushText('"',"yank","abc\ndef",false);c.doKeys("p");eq("__abc\ndef_",a.getValue());c.assertCursorAt(1,2)},{value:"___"});testVim("p_register",function(a,b,c){a.setCursor(0,1);c.getRegisterController().getRegister("a").setText("abc\ndef",false);c.doKeys('"',"a","p");eq("__abc\ndef_",a.getValue());c.assertCursorAt(1,2)},{value:"___"});testVim("p_wrong_register",function(a,b,c){a.setCursor(0,1);c.getRegisterController().getRegister("a").setText("abc\ndef",false);c.doKeys("p");eq("___",a.getValue());c.assertCursorAt(0,1)},{value:"___"});testVim("p_line",function(a,b,c){a.setCursor(0,1);c.getRegisterController().pushText('"',"yank","  a\nd\n",true);c.doKeys("2","p");eq("___\n  a\nd\n  a\nd",a.getValue());c.assertCursorAt(1,2)},{value:"___"});testVim("p_lastline",function(a,b,c){a.setCursor(0,1);c.getRegisterController().pushText('"',"yank","  a\nd",true);c.doKeys("2","p");eq("___\n  a\nd\n  a\nd",a.getValue());c.assertCursorAt(1,2)},{value:"___"});testVim("]p_first_indent_is_smaller",function(a,b,c){c.getRegisterController().pushText('"',"yank","  abc\n    def\n",true);c.doKeys("]","p");eq("  ___\n  abc\n    def",a.getValue())},{value:"  ___"});testVim("]p_first_indent_is_larger",function(a,b,c){c.getRegisterController().pushText('"',"yank","    abc\n  def\n",true);c.doKeys("]","p");eq("  ___\n  abc\ndef",a.getValue())},{value:"  ___"});testVim("]p_with_tab_indents",function(a,b,c){c.getRegisterController().pushText('"',"yank","\t\tabc\n\t\t\tdef\n",true);c.doKeys("]","p");eq("\t___\n\tabc\n\t\tdef",a.getValue())},{value:"\t___",indentWithTabs:true});testVim("]p_with_spaces_translated_to_tabs",function(a,b,c){c.getRegisterController().pushText('"',"yank","  abc\n    def\n",true);c.doKeys("]","p");eq("\t___\n\tabc\n\t\tdef",a.getValue())},{value:"\t___",indentWithTabs:true,tabSize:2});testVim("[p",function(a,b,c){c.getRegisterController().pushText('"',"yank","  abc\n    def\n",true);c.doKeys("[","p");eq("  abc\n    def\n  ___",a.getValue())},{value:"  ___"});testVim("P",function(a,b,c){a.setCursor(0,1);c.getRegisterController().pushText('"',"yank","abc\ndef",false);c.doKeys("P");eq("_abc\ndef__",a.getValue());c.assertCursorAt(1,3)},{value:"___"});testVim("P_line",function(a,b,c){a.setCursor(0,1);c.getRegisterController().pushText('"',"yank","  a\nd\n",true);c.doKeys("2","P");eq("  a\nd\n  a\nd\n___",a.getValue());c.assertCursorAt(0,2)},{value:"___"});testVim("r",function(a,b,c){a.setCursor(0,1);c.doKeys("3","r","u");eq("wuuuet\nanother",a.getValue(),"3r failed");c.assertCursorAt(0,3);a.setCursor(0,4);c.doKeys("v","j","h","r","<Space>");eq("wuuu  \n    her",a.getValue(),"Replacing selection by space-characters failed")},{value:"wordet\nanother"});testVim("r_visual_block",function(a,b,c){a.setCursor(2,3);c.doKeys("<C-v>","k","k","h","h","r","l");eq("1lll\n5lll\nalllefg",a.getValue());c.doKeys("<C-v>","l","j","r","<Space>");eq("1  l\n5  l\nalllefg",a.getValue());a.setCursor(2,0);c.doKeys("o");c.doKeys("<Esc>");a.replaceRange("\t\t",a.getCursor());c.doKeys("<C-v>","h","h","r","r");eq("1  l\n5  l\nalllefg\nrrrrrrrr",a.getValue())},{value:"1234\n5678\nabcdefg"});testVim("R",function(a,b,c){a.setCursor(0,1);c.doKeys("R");c.assertCursorAt(0,1);eq("vim-replace",a.getOption("keyMap"));is(a.state.overwrite,"Setting overwrite state failed")});testVim("mark",function(a,b,c){a.setCursor(2,2);c.doKeys("m","t");a.setCursor(0,0);c.doKeys("`","t");c.assertCursorAt(2,2);a.setCursor(2,0);a.replaceRange("   h",a.getCursor());a.setCursor(0,0);c.doKeys("'","t");c.assertCursorAt(2,3)});testVim("jumpToMark_next",function(a,b,c){a.setCursor(2,2);c.doKeys("m","t");a.setCursor(0,0);c.doKeys("]","`");c.assertCursorAt(2,2);a.setCursor(0,0);c.doKeys("]","'");c.assertCursorAt(2,0)});testVim("jumpToMark_next_repeat",function(a,b,c){a.setCursor(2,2);c.doKeys("m","a");a.setCursor(3,2);c.doKeys("m","b");a.setCursor(4,2);c.doKeys("m","c");a.setCursor(0,0);c.doKeys("2","]","`");c.assertCursorAt(3,2);a.setCursor(0,0);c.doKeys("2","]","'");c.assertCursorAt(3,1)});testVim("jumpToMark_next_sameline",function(a,b,c){a.setCursor(2,0);c.doKeys("m","a");a.setCursor(2,4);c.doKeys("m","b");a.setCursor(2,2);c.doKeys("]","`");c.assertCursorAt(2,4)});testVim("jumpToMark_next_onlyprev",function(a,b,c){a.setCursor(2,0);c.doKeys("m","a");a.setCursor(4,0);c.doKeys("]","`");c.assertCursorAt(4,0)});testVim("jumpToMark_next_nomark",function(a,b,c){a.setCursor(2,2);c.doKeys("]","`");c.assertCursorAt(2,2);c.doKeys("]","'");c.assertCursorAt(2,0)});testVim("jumpToMark_next_linewise_over",function(a,b,c){a.setCursor(2,2);c.doKeys("m","a");a.setCursor(3,4);c.doKeys("m","b");a.setCursor(2,1);c.doKeys("]","'");c.assertCursorAt(3,1)});testVim("jumpToMark_next_action",function(a,b,d){a.setCursor(2,2);d.doKeys("m","t");a.setCursor(0,0);d.doKeys("d","]","`");d.assertCursorAt(0,0);var e=a.getLine(0);var c="pop pop 0 1 2 3 4";eq(e,c,"Deleting while jumping to the next mark failed.")});testVim("jumpToMark_next_line_action",function(a,b,d){a.setCursor(2,2);d.doKeys("m","t");a.setCursor(0,0);d.doKeys("d","]","'");d.assertCursorAt(0,1);var e=a.getLine(0);var c=" (a) [b] {c} ";eq(e,c,"Deleting while jumping to the next mark line failed.")});testVim("jumpToMark_prev",function(a,b,c){a.setCursor(2,2);c.doKeys("m","t");a.setCursor(4,0);c.doKeys("[","`");c.assertCursorAt(2,2);a.setCursor(4,0);c.doKeys("[","'");c.assertCursorAt(2,0)});testVim("jumpToMark_prev_repeat",function(a,b,c){a.setCursor(2,2);c.doKeys("m","a");a.setCursor(3,2);c.doKeys("m","b");a.setCursor(4,2);c.doKeys("m","c");a.setCursor(5,0);c.doKeys("2","[","`");c.assertCursorAt(3,2);a.setCursor(5,0);c.doKeys("2","[","'");c.assertCursorAt(3,1)});testVim("jumpToMark_prev_sameline",function(a,b,c){a.setCursor(2,0);c.doKeys("m","a");a.setCursor(2,4);c.doKeys("m","b");a.setCursor(2,2);c.doKeys("[","`");c.assertCursorAt(2,0)});testVim("jumpToMark_prev_onlynext",function(a,b,c){a.setCursor(4,4);c.doKeys("m","a");a.setCursor(2,0);c.doKeys("[","`");c.assertCursorAt(2,0)});testVim("jumpToMark_prev_nomark",function(a,b,c){a.setCursor(2,2);c.doKeys("[","`");c.assertCursorAt(2,2);c.doKeys("[","'");c.assertCursorAt(2,0)});testVim("jumpToMark_prev_linewise_over",function(a,b,c){a.setCursor(2,2);c.doKeys("m","a");a.setCursor(3,4);c.doKeys("m","b");a.setCursor(3,6);c.doKeys("[","'");c.assertCursorAt(2,0)});testVim("delmark_single",function(a,b,c){a.setCursor(1,2);c.doKeys("m","t");c.doEx("delmarks t");a.setCursor(0,0);c.doKeys("`","t");c.assertCursorAt(0,0)});testVim("delmark_range",function(a,b,c){a.setCursor(1,2);c.doKeys("m","a");a.setCursor(2,2);c.doKeys("m","b");a.setCursor(3,2);c.doKeys("m","c");a.setCursor(4,2);c.doKeys("m","d");a.setCursor(5,2);c.doKeys("m","e");c.doEx("delmarks b-d");a.setCursor(0,0);c.doKeys("`","a");c.assertCursorAt(1,2);c.doKeys("`","b");c.assertCursorAt(1,2);c.doKeys("`","c");c.assertCursorAt(1,2);c.doKeys("`","d");c.assertCursorAt(1,2);c.doKeys("`","e");c.assertCursorAt(5,2)});testVim("delmark_multi",function(a,b,c){a.setCursor(1,2);c.doKeys("m","a");a.setCursor(2,2);c.doKeys("m","b");a.setCursor(3,2);c.doKeys("m","c");a.setCursor(4,2);c.doKeys("m","d");a.setCursor(5,2);c.doKeys("m","e");c.doEx("delmarks bcd");a.setCursor(0,0);c.doKeys("`","a");c.assertCursorAt(1,2);c.doKeys("`","b");c.assertCursorAt(1,2);c.doKeys("`","c");c.assertCursorAt(1,2);c.doKeys("`","d");c.assertCursorAt(1,2);c.doKeys("`","e");c.assertCursorAt(5,2)});testVim("delmark_multi_space",function(a,b,c){a.setCursor(1,2);c.doKeys("m","a");a.setCursor(2,2);c.doKeys("m","b");a.setCursor(3,2);c.doKeys("m","c");a.setCursor(4,2);c.doKeys("m","d");a.setCursor(5,2);c.doKeys("m","e");c.doEx("delmarks b c d");a.setCursor(0,0);c.doKeys("`","a");c.assertCursorAt(1,2);c.doKeys("`","b");c.assertCursorAt(1,2);c.doKeys("`","c");c.assertCursorAt(1,2);c.doKeys("`","d");c.assertCursorAt(1,2);c.doKeys("`","e");c.assertCursorAt(5,2)});testVim("delmark_all",function(a,b,c){a.setCursor(1,2);c.doKeys("m","a");a.setCursor(2,2);c.doKeys("m","b");a.setCursor(3,2);c.doKeys("m","c");a.setCursor(4,2);c.doKeys("m","d");a.setCursor(5,2);c.doKeys("m","e");c.doEx("delmarks a b-de");a.setCursor(0,0);c.doKeys("`","a");c.assertCursorAt(0,0);c.doKeys("`","b");c.assertCursorAt(0,0);c.doKeys("`","c");c.assertCursorAt(0,0);c.doKeys("`","d");c.assertCursorAt(0,0);c.doKeys("`","e");c.assertCursorAt(0,0)});testVim("visual",function(a,b,c){c.doKeys("l","v","l","l");c.assertCursorAt(0,4);eqPos(makeCursor(0,1),a.getCursor("anchor"));c.doKeys("d");eq("15",a.getValue())},{value:"12345"});testVim("visual_yank",function(a,b,c){c.doKeys("v","3","l","y");c.assertCursorAt(0,0);c.doKeys("p");eq("aa te test for yank",a.getValue())},{value:"a test for yank"});testVim("visual_w",function(a,b,c){c.doKeys("v","w");eq(a.getSelection(),"motion t")},{value:"motion test"});testVim("visual_initial_selection",function(a,b,c){a.setCursor(0,1);c.doKeys("v");a.getSelection("n")},{value:"init"});testVim("visual_crossover_left",function(a,b,c){a.setCursor(0,2);c.doKeys("v","l","h","h");a.getSelection("ro")},{value:"cross"});testVim("visual_crossover_left",function(a,b,c){a.setCursor(0,2);c.doKeys("v","h","l","l");a.getSelection("os")},{value:"cross"});testVim("visual_crossover_up",function(a,b,c){a.setCursor(3,2);c.doKeys("v","j","k","k");eqPos(Pos(2,2),a.getCursor("head"));eqPos(Pos(3,3),a.getCursor("anchor"));c.doKeys("k");eqPos(Pos(1,2),a.getCursor("head"));eqPos(Pos(3,3),a.getCursor("anchor"))},{value:"cross\ncross\ncross\ncross\ncross\n"});testVim("visual_crossover_down",function(a,b,c){a.setCursor(1,2);c.doKeys("v","k","j","j");eqPos(Pos(2,3),a.getCursor("head"));eqPos(Pos(1,2),a.getCursor("anchor"));c.doKeys("j");eqPos(Pos(3,3),a.getCursor("head"));eqPos(Pos(1,2),a.getCursor("anchor"))},{value:"cross\ncross\ncross\ncross\ncross\n"});testVim("visual_exit",function(a,b,c){c.doKeys("<C-v>","l","j","j","<Esc>");eqPos(a.getCursor("anchor"),a.getCursor("head"));eq(b.visualMode,false)},{value:"hello\nworld\nfoo"});testVim("visual_line",function(a,b,c){c.doKeys("l","V","l","j","j","d");eq(" 4\n 5",a.getValue())},{value:" 1\n 2\n 3\n 4\n 5"});testVim("visual_block_move_to_eol",function(a,b,d){a.setCursor(0,0);d.doKeys("<C-v>","G","$");var c=a.getSelections().join();eq("123,45,6",c);d.doKeys("2","k","b");c=a.getSelections().join();eq("1",c)},{value:"123\n45\n6"});testVim("visual_block_different_line_lengths",function(a,b,c){c.doKeys("<C-v>","l","j","j","6","l","d");c.doKeys("d","d","d","d");eq("",a.getValue())},{value:"1234\n5678\nabcdefg"});testVim("visual_block_truncate_on_short_line",function(a,b,c){a.replaceRange("",a.getCursor());a.setCursor(3,4);c.doKeys("<C-v>","l","k","k","d");eq("hello world\n{\ntis\nsa!",a.getValue())},{value:"hello world\n{\nthis is\nsparta!"});testVim("visual_block_corners",function(a,b,d){a.setCursor(1,2);d.doKeys("<C-v>","2","l","k");var c=a.getSelections();eq("345891",c.join(""));d.doKeys("4","h");c=a.getSelections();eq("123678",c.join(""));d.doKeys("j","j");c=a.getSelections();eq("678abc",c.join(""));d.doKeys("4","l");c=a.getSelections();eq("891cde",c.join(""))},{value:"12345\n67891\nabcde"});testVim("visual_block_mode_switch",function(a,b,c){a.setCursor(1,1);c.doKeys("<C-v>","j","l","v");selections=a.getSelections();eq("7891\nabc",selections.join(""));c.doKeys("<C-v>");selections=a.getSelections();eq("78bc",selections.join(""));c.doKeys("V");selections=a.getSelections();eq("67891\nabcde",selections.join(""))},{value:"12345\n67891\nabcde"});testVim("visual_block_crossing_short_line",function(a,b,d){a.setCursor(0,3);d.doKeys("<C-v>","j","j","j");var c=a.getSelections().join();eq("4,,d,b",c);d.doKeys("3","k");c=a.getSelections().join();eq("4",c);d.doKeys("5","j","k");c=a.getSelections().join("");eq(10,c.length)},{value:"123456\n78\nabcdefg\nfoobar\n}\n"});testVim("visual_block_curPos_on_exit",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-v>","3","l","<Esc>");eqPos(makeCursor(0,3),a.getCursor());c.doKeys("h","<C-v>","2","j","3","l");eq(a.getSelections().join(),"3456,,cdef");c.doKeys("4","h");eq(a.getSelections().join(),"23,8,bc");c.doKeys("2","l");eq(a.getSelections().join(),"34,,cd")},{value:"123456\n78\nabcdefg\nfoobar"});testVim("visual_marks",function(a,b,c){c.doKeys("l","v","l","l","j","j","v");a.setCursor(2,1);c.doKeys("'","<");c.assertCursorAt(0,1);c.doKeys("'",">");c.assertCursorAt(2,0)});testVim("visual_join",function(a,b,c){c.doKeys("l","V","l","j","j","J");eq(" 1 2 3\n 4\n 5",a.getValue());is(!b.visualMode)},{value:" 1\n 2\n 3\n 4\n 5"});testVim("visual_join_2",function(a,b,c){c.doKeys("G","V","g","g","J");eq("1 2 3 4 5 6 ",a.getValue());is(!b.visualMode)},{value:"1\n2\n3\n4\n5\n6\n"});testVim("visual_blank",function(a,b,c){c.doKeys("v","k");eq(b.visualMode,true)},{value:"\n"});testVim("reselect_visual",function(a,b,c){c.doKeys("l","v","l","l","l","y","g","v");c.assertCursorAt(0,5);eqPos(makeCursor(0,1),a.getCursor("anchor"));c.doKeys("v");a.setCursor(1,0);c.doKeys("v","l","l","p");eq("123456\n2345\nbar",a.getValue());a.setCursor(0,0);c.doKeys("g","v");c.assertCursorAt(1,4);eqPos(makeCursor(1,0),a.getCursor("anchor"));c.doKeys("v");a.setCursor(2,0);c.doKeys("v","l","l","g","v");c.assertCursorAt(1,4);eqPos(makeCursor(1,0),a.getCursor("anchor"));c.doKeys("g","v");c.assertCursorAt(2,3);eqPos(makeCursor(2,0),a.getCursor("anchor"));eq("123456\n2345\nbar",a.getValue())},{value:"123456\nfoo\nbar"});testVim("reselect_visual_line",function(a,b,c){c.doKeys("l","V","j","j","V","g","v","d");eq("foo\nand\nbar",a.getValue());a.setCursor(1,0);c.doKeys("V","y","j");c.doKeys("V","p","g","v","d");eq("foo\nand",a.getValue())},{value:"hello\nthis\nis\nfoo\nand\nbar"});testVim("reselect_visual_block",function(a,b,c){a.setCursor(1,2);c.doKeys("<C-v>","k","h","<C-v>");a.setCursor(2,1);c.doKeys("v","l","g","v");eqPos(Pos(1,2),b.sel.anchor);eqPos(Pos(0,1),b.sel.head);eq(a.getSelections().join(""),"23oo");c.doKeys("g","v");eqPos(Pos(2,1),b.sel.anchor);eqPos(Pos(2,2),b.sel.head);c.doKeys("<Esc>");a.setCursor(1,1);c.doKeys("v","<C-v>","j","d","g","v");eq(a.getSelections().join(""),"or")},{value:"123456\nfoo\nbar"});testVim("s_normal",function(a,b,c){a.setCursor(0,1);c.doKeys("s");c.doKeys("<Esc>");eq("ac",a.getValue())},{value:"abc"});testVim("s_visual",function(a,b,c){a.setCursor(0,1);c.doKeys("v","s");c.doKeys("<Esc>");c.assertCursorAt(0,0);eq("ac",a.getValue())},{value:"abc"});testVim("o_visual",function(a,b,c){a.setCursor(0,0);c.doKeys("v","l","l","l","o");c.assertCursorAt(0,0);c.doKeys("v","v","j","j","j","o");c.assertCursorAt(0,0);c.doKeys("O");c.doKeys("l","l");c.assertCursorAt(3,3);c.doKeys("d");eq("p",a.getValue())},{value:"abcd\nefgh\nijkl\nmnop"});testVim("o_visual_block",function(a,b,c){a.setCursor(0,1);c.doKeys("<C-v>","3","j","l","l","o");eqPos(Pos(3,3),b.sel.anchor);eqPos(Pos(0,1),b.sel.head);c.doKeys("O");eqPos(Pos(3,1),b.sel.anchor);eqPos(Pos(0,3),b.sel.head);c.doKeys("o");eqPos(Pos(0,3),b.sel.anchor);eqPos(Pos(3,1),b.sel.head)},{value:"abcd\nefgh\nijkl\nmnop"});testVim("changeCase_visual",function(a,b,c){a.setCursor(0,0);c.doKeys("v","l","l");c.doKeys("U");c.assertCursorAt(0,0);c.doKeys("v","l","l");c.doKeys("u");c.assertCursorAt(0,0);c.doKeys("l","l","l",".");c.assertCursorAt(0,3);a.setCursor(0,0);c.doKeys("q","a","v","j","U","q");c.assertCursorAt(0,0);c.doKeys("j","@","a");c.assertCursorAt(1,0);a.setCursor(3,0);c.doKeys("V","U","j",".");eq("ABCDEF\nGHIJKL\nMnopq\nSHORT LINE\nLONG LINE OF TEXT",a.getValue())},{value:"abcdef\nghijkl\nmnopq\nshort line\nlong line of text"});testVim("changeCase_visual_block",function(a,b,c){a.setCursor(2,1);c.doKeys("<C-v>","k","k","h","U");eq("ABcdef\nGHijkl\nMNopq\nfoo",a.getValue());a.setCursor(0,2);c.doKeys(".");eq("ABCDef\nGHIJkl\nMNOPq\nfoo",a.getValue());a.setCursor(2,2);c.doKeys(".");eq("ABCDef\nGHIJkl\nMNOPq\nfoO",a.getValue())},{value:"abcdef\nghijkl\nmnopq\nfoo"});testVim("visual_paste",function(a,b,c){a.setCursor(0,0);c.doKeys("v","l","l","y");c.assertCursorAt(0,0);c.doKeys("3","l","j","v","l","p");c.assertCursorAt(1,5);eq("this is a\nunithitest for visual paste",a.getValue());a.setCursor(0,0);c.doKeys("y","y");a.setCursor(1,6);c.doKeys("v","l","l","l","p");c.assertCursorAt(2,0);eq("this is a\nunithi\nthis is a\n for visual paste",a.getValue())},{value:"this is a\nunit test for visual paste"});testVim("v_paste_from_register",function(a,b,c){a.setCursor(0,0);c.doKeys('"',"a","y","w");a.setCursor(1,0);c.doKeys("v","p");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+register/.test(d))})},{value:"register contents\nare not erased"});testVim("S_normal",function(a,b,c){a.setCursor(0,1);c.doKeys("j","S");c.doKeys("<Esc>");c.assertCursorAt(1,0);eq("aa\n\ncc",a.getValue())},{value:"aa\nbb\ncc"});testVim("blockwise_paste",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-v>","3","j","l","y");a.setCursor(0,2);c.doKeys("p");eq("helhelo\nworwold\nfoofo\nbarba",a.getValue());a.setCursor(0,0);c.doKeys("v","4","l","y");a.setCursor(0,0);c.doKeys("<C-v>","3","j","p");eq("helheelhelo\norwold\noofo\narba",a.getValue())},{value:"hello\nworld\nfoo\nbar"});testVim("blockwise_paste_long/short_line",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-v>","j","j","y");a.setCursor(0,3);c.doKeys("p");eq("hellho\nfoo f\nbar b",a.getValue())},{value:"hello\nfoo\nbar"});testVim("blockwise_paste_cut_paste",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-v>","2","j","x");a.setCursor(0,0);c.doKeys("P");eq("cut\nand\npaste\nme",a.getValue())},{value:"cut\nand\npaste\nme"});testVim("blockwise_paste_from_register",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-v>","2","j",'"',"a","y");a.setCursor(0,3);c.doKeys('"',"a","p");eq("foobfar\nhellho\nworlwd",a.getValue())},{value:"foobar\nhello\nworld"});testVim("blockwise_paste_last_line",function(a,b,c){a.setCursor(0,0);c.doKeys("<C-v>","2","j","l","y");a.setCursor(3,0);c.doKeys("p");eq("cut\nand\npaste\nmcue\n an\n pa",a.getValue())},{value:"cut\nand\npaste\nme"});testVim("S_visual",function(a,b,c){a.setCursor(0,1);c.doKeys("v","j","S");c.doKeys("<Esc>");c.assertCursorAt(0,0);eq("\ncc",a.getValue())},{value:"aa\nbb\ncc"});testVim("d_/",function(a,b,c){a.openDialog=c.fakeOpenDialog("match");c.doKeys("2","d","/");c.assertCursorAt(0,0);eq("match \n next",a.getValue());a.openDialog=c.fakeOpenDialog("2");c.doKeys("d",":")},{value:"text match match \n next"});testVim("/ and n/N",function(a,b,c){a.openDialog=c.fakeOpenDialog("match");c.doKeys("/");c.assertCursorAt(0,11);c.doKeys("n");c.assertCursorAt(1,6);c.doKeys("N");c.assertCursorAt(0,11);a.setCursor(0,0);c.doKeys("2","/");c.assertCursorAt(1,6)},{value:"match nope match \n nope Match"});testVim("/_case",function(a,b,c){a.openDialog=c.fakeOpenDialog("Match");c.doKeys("/");c.assertCursorAt(1,6)},{value:"match nope match \n nope Match"});testVim("/_2_pcre",function(a,b,c){CodeMirror.Vim.setOption("pcre",true);a.openDialog=c.fakeOpenDialog("(word){2}");c.doKeys("/");c.assertCursorAt(1,9);c.doKeys("n");c.assertCursorAt(2,1)},{value:"word\n another wordword\n wordwordword\n"});testVim("/_2_nopcre",function(a,b,c){CodeMirror.Vim.setOption("pcre",false);a.openDialog=c.fakeOpenDialog("\\(word\\)\\{2}");c.doKeys("/");c.assertCursorAt(1,9);c.doKeys("n");c.assertCursorAt(2,1)},{value:"word\n another wordword\n wordwordword\n"});testVim("/_nongreedy",function(a,b,c){a.openDialog=c.fakeOpenDialog("aa");c.doKeys("/");c.assertCursorAt(0,4);c.doKeys("n");c.assertCursorAt(1,3);c.doKeys("n");c.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("?_nongreedy",function(a,b,c){a.openDialog=c.fakeOpenDialog("aa");c.doKeys("?");c.assertCursorAt(1,3);c.doKeys("n");c.assertCursorAt(0,4);c.doKeys("n");c.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("/_greedy",function(a,b,c){a.openDialog=c.fakeOpenDialog("a+");c.doKeys("/");c.assertCursorAt(0,4);c.doKeys("n");c.assertCursorAt(1,1);c.doKeys("n");c.assertCursorAt(1,3);c.doKeys("n");c.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("?_greedy",function(a,b,c){a.openDialog=c.fakeOpenDialog("a+");c.doKeys("?");c.assertCursorAt(1,3);c.doKeys("n");c.assertCursorAt(1,1);c.doKeys("n");c.assertCursorAt(0,4);c.doKeys("n");c.assertCursorAt(0,0)},{value:"aaa aa \n a aa"});testVim("/_greedy_0_or_more",function(a,b,c){a.openDialog=c.fakeOpenDialog("a*");c.doKeys("/");c.assertCursorAt(0,3);c.doKeys("n");c.assertCursorAt(0,4);c.doKeys("n");c.assertCursorAt(0,5);c.doKeys("n");c.assertCursorAt(1,0);c.doKeys("n");c.assertCursorAt(1,1);c.doKeys("n");c.assertCursorAt(0,0)},{value:"aaa  aa\n aa"});testVim("?_greedy_0_or_more",function(a,b,c){a.openDialog=c.fakeOpenDialog("a*");c.doKeys("?");c.assertCursorAt(1,1);c.doKeys("n");c.assertCursorAt(1,0);c.doKeys("n");c.assertCursorAt(0,5);c.doKeys("n");c.assertCursorAt(0,4);c.doKeys("n");c.assertCursorAt(0,3);c.doKeys("n");c.assertCursorAt(0,0)},{value:"aaa  aa\n aa"});testVim("? and n/N",function(a,b,c){a.openDialog=c.fakeOpenDialog("match");c.doKeys("?");c.assertCursorAt(1,6);c.doKeys("n");c.assertCursorAt(0,11);c.doKeys("N");c.assertCursorAt(1,6);a.setCursor(0,0);c.doKeys("2","?");c.assertCursorAt(0,11)},{value:"match nope match \n nope Match"});testVim("*",function(a,b,c){a.setCursor(0,9);c.doKeys("*");c.assertCursorAt(0,22);a.setCursor(0,9);c.doKeys("2","*");c.assertCursorAt(1,8)},{value:"nomatch match nomatch match \nnomatch Match"});testVim("*_no_word",function(a,b,c){a.setCursor(0,0);c.doKeys("*");c.assertCursorAt(0,0)},{value:" \n match \n"});testVim("*_symbol",function(a,b,c){a.setCursor(0,0);c.doKeys("*");c.assertCursorAt(1,0)},{value:" /}\n/} match \n"});testVim("#",function(a,b,c){a.setCursor(0,9);c.doKeys("#");c.assertCursorAt(1,8);a.setCursor(0,9);c.doKeys("2","#");c.assertCursorAt(0,22)},{value:"nomatch match nomatch match \nnomatch Match"});testVim("*_seek",function(a,b,c){a.setCursor(0,3);c.doKeys("*");c.assertCursorAt(0,22)},{value:"    :=  match nomatch match \nnomatch Match"});testVim("#",function(a,b,c){a.setCursor(0,3);c.doKeys("#");c.assertCursorAt(1,8)},{value:"    :=  match nomatch match \nnomatch Match"});testVim("g*",function(a,b,c){a.setCursor(0,8);c.doKeys("g","*");c.assertCursorAt(0,18);a.setCursor(0,8);c.doKeys("3","g","*");c.assertCursorAt(1,8)},{value:"matches match alsoMatch\nmatchme matching"});testVim("g#",function(a,b,c){a.setCursor(0,8);c.doKeys("g","#");c.assertCursorAt(0,0);a.setCursor(0,8);c.doKeys("3","g","#");c.assertCursorAt(1,0)},{value:"matches match alsoMatch\nmatchme matching"});testVim("macro_insert",function(a,b,c){a.setCursor(0,0);c.doKeys("q","a","0","i");a.replaceRange("foo",a.getCursor());c.doKeys("<Esc>");c.doKeys("q","@","a");eq("foofoo",a.getValue())},{value:""});testVim("macro_insert_repeat",function(a,b,c){a.setCursor(0,0);c.doKeys("q","a","$","a");a.replaceRange("larry.",a.getCursor());c.doKeys("<Esc>");c.doKeys("a");a.replaceRange("curly.",a.getCursor());c.doKeys("<Esc>");c.doKeys("q");c.doKeys("a");a.replaceRange("moe.",a.getCursor());c.doKeys("<Esc>");c.doKeys("@","a");c.doKeys(".");eq("larry.curly.moe.larry.curly.curly.",a.getValue())},{value:""});testVim("macro_space",function(a,b,c){a.setCursor(0,0);c.doKeys("<Space>","<Space>");c.assertCursorAt(0,2);c.doKeys("q","a","<Space>","<Space>","q");c.assertCursorAt(0,4);c.doKeys("@","a");c.assertCursorAt(0,6);c.doKeys("@","a");c.assertCursorAt(0,8)},{value:"one line of text."});testVim("macro_t_search",function(a,b,c){a.setCursor(0,0);c.doKeys("q","a","t","e","q");c.assertCursorAt(0,1);c.doKeys("l","@","a");c.assertCursorAt(0,6);c.doKeys("l",";");c.assertCursorAt(0,12)},{value:"one line of text."});testVim("macro_f_search",function(a,b,c){a.setCursor(0,0);c.doKeys("q","b","f","e","q");c.assertCursorAt(0,2);c.doKeys("@","b");c.assertCursorAt(0,7);c.doKeys(";");c.assertCursorAt(0,13)},{value:"one line of text."});testVim("macro_slash_search",function(a,b,c){a.setCursor(0,0);c.doKeys("q","c");a.openDialog=c.fakeOpenDialog("e");c.doKeys("/","q");c.assertCursorAt(0,2);c.doKeys("@","c");c.assertCursorAt(0,7);c.doKeys("n");c.assertCursorAt(0,13)},{value:"one line of text."});testVim("macro_multislash_search",function(a,b,c){a.setCursor(0,0);c.doKeys("q","d");a.openDialog=c.fakeOpenDialog("e");c.doKeys("/");a.openDialog=c.fakeOpenDialog("t");c.doKeys("/","q");c.assertCursorAt(0,12);c.doKeys("@","d");c.assertCursorAt(0,15)},{value:"one line of text to rule them all."});testVim("macro_last_ex_command_register",function(a,b,c){a.setCursor(0,0);c.doEx("s/a/b");c.doKeys("2","@",":");eq("bbbaa",a.getValue());c.assertCursorAt(0,2)},{value:"aaaaa"});testVim("macro_parens",function(a,b,c){a.setCursor(0,0);c.doKeys("q","z","i");a.replaceRange("(",a.getCursor());c.doKeys("<Esc>");c.doKeys("e","a");a.replaceRange(")",a.getCursor());c.doKeys("<Esc>");c.doKeys("q");c.doKeys("w","@","z");c.doKeys("w","@","z");eq("(see) (spot) (run)",a.getValue())},{value:"see spot run"});testVim("macro_overwrite",function(a,b,c){a.setCursor(0,0);c.doKeys("q","z","0","i");a.replaceRange("I ",a.getCursor());c.doKeys("<Esc>");c.doKeys("q");c.doKeys("e");c.doKeys("q","z","a");a.replaceRange(".",a.getCursor());c.doKeys("<Esc>");c.doKeys("q");c.doKeys("e","@","z");c.doKeys("e","@","z");eq("I see. spot. run.",a.getValue())},{value:"see spot run"});testVim("macro_search_f",function(a,b,c){a.setCursor(0,0);c.doKeys("q","a","f"," ");c.assertCursorAt(0,3);c.doKeys("q","0");c.assertCursorAt(0,0);c.doKeys("@","a");c.assertCursorAt(0,3)},{value:"The quick brown fox jumped over the lazy dog."});testVim("macro_search_2f",function(a,b,c){a.setCursor(0,0);c.doKeys("q","a","2","f"," ");c.assertCursorAt(0,9);c.doKeys("q","0");c.assertCursorAt(0,0);c.doKeys("@","a");c.assertCursorAt(0,9)},{value:"The quick brown fox jumped over the lazy dog."});testVim("yank_register",function(a,b,c){a.setCursor(0,0);c.doKeys('"',"a","y","y");c.doKeys("j",'"',"b","y","y");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+foo/.test(d));is(/b\s+bar/.test(d))});c.doKeys(":")},{value:"foo\nbar"});testVim("yank_visual_block",function(a,b,c){a.setCursor(0,1);c.doKeys("<C-v>","l","j",'"',"a","y");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+oo\nar/.test(d))});c.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_line_to_line_register",function(a,b,c){a.setCursor(0,0);c.doKeys('"',"a","y","y");c.doKeys("j",'"',"A","y","y");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+foo\nbar/.test(d));is(/"\s+foo\nbar/.test(d))});c.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_word_to_word_register",function(a,b,c){a.setCursor(0,0);c.doKeys('"',"a","y","w");c.doKeys("j",'"',"A","y","w");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+foobar/.test(d));is(/"\s+foobar/.test(d))});c.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_line_to_word_register",function(a,b,c){a.setCursor(0,0);c.doKeys('"',"a","y","w");c.doKeys("j",'"',"A","y","y");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+foo\nbar/.test(d));is(/"\s+foo\nbar/.test(d))});c.doKeys(":")},{value:"foo\nbar"});testVim("yank_append_word_to_line_register",function(a,b,c){a.setCursor(0,0);c.doKeys('"',"a","y","y");c.doKeys("j",'"',"A","y","w");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+foo\nbar/.test(d));is(/"\s+foo\nbar/.test(d))});c.doKeys(":")},{value:"foo\nbar"});testVim("macro_register",function(a,b,c){a.setCursor(0,0);c.doKeys("q","a","i");a.replaceRange("gangnam",a.getCursor());c.doKeys("<Esc>");c.doKeys("q");c.doKeys("q","b","o");a.replaceRange("style",a.getCursor());c.doKeys("<Esc>");c.doKeys("q");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/a\s+i/.test(d));is(/b\s+o/.test(d))});c.doKeys(":")},{value:""});testVim("._register",function(a,b,c){a.setCursor(0,0);c.doKeys("i");a.replaceRange("foo",a.getCursor());c.doKeys("<Esc>");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/\.\s+foo/.test(d))});c.doKeys(":")},{value:""});testVim(":_register",function(a,b,c){c.doEx("bar");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/:\s+bar/.test(d))});c.doKeys(":")},{value:""});testVim("search_register_escape",function(a,b,f){a.openDialog=f.fakeOpenDialog("waldo");f.doKeys("/");var d;var c;var e={f:70,o:79,Esc:27};a.openDialog=function(i,j,h){d=h.onKeyDown;c=h.onKeyUp};var g=function(){};f.doKeys("/");d({keyCode:e.f},"",g);c({keyCode:e.f},"",g);d({keyCode:e.o},"f",g);c({keyCode:e.o},"f",g);d({keyCode:e.o},"fo",g);c({keyCode:e.o},"fo",g);d({keyCode:e.Esc},"foo",g);a.openDialog=f.fakeOpenDialog("registers");a.openNotification=f.fakeOpenNotification(function(h){is(/waldo/.test(h));is(!/foo/.test(h))});f.doKeys(":")},{value:""});testVim("search_register",function(a,b,c){a.openDialog=c.fakeOpenDialog("foo");c.doKeys("/");a.openDialog=c.fakeOpenDialog("registers");a.openNotification=c.fakeOpenNotification(function(d){is(/\/\s+foo/.test(d))});c.doKeys(":")},{value:""});testVim("search_history",function(a,b,f){a.openDialog=f.fakeOpenDialog("this");f.doKeys("/");a.openDialog=f.fakeOpenDialog("checks");f.doKeys("/");a.openDialog=f.fakeOpenDialog("search");f.doKeys("/");a.openDialog=f.fakeOpenDialog("history");f.doKeys("/");a.openDialog=f.fakeOpenDialog("checks");f.doKeys("/");var e;var d;var g="";var c={Up:38,Down:40};a.openDialog=function(j,k,i){d=i.onKeyUp;e=i.onKeyDown};var h=function(i){if(typeof i=="string"){g=i}};f.doKeys("/");e({keyCode:c.Up},g,h);d({keyCode:c.Up},g,h);eq(g,"checks");e({keyCode:c.Up},g,h);d({keyCode:c.Up},g,h);eq(g,"history");e({keyCode:c.Up},g,h);d({keyCode:c.Up},g,h);eq(g,"search");e({keyCode:c.Up},g,h);d({keyCode:c.Up},g,h);eq(g,"this");e({keyCode:c.Down},g,h);d({keyCode:c.Down},g,h);eq(g,"search")},{value:""});testVim("exCommand_history",function(a,c,g){a.openDialog=g.fakeOpenDialog("registers");g.doKeys(":");a.openDialog=g.fakeOpenDialog("sort");g.doKeys(":");a.openDialog=g.fakeOpenDialog("map");g.doKeys(":");a.openDialog=g.fakeOpenDialog("invalid");g.doKeys(":");var f;var e;var b="";var d={Up:38,Down:40,s:115};a.openDialog=function(j,k,i){e=i.onKeyUp;f=i.onKeyDown};var h=function(i){if(typeof i=="string"){b=i}};g.doKeys(":");f({keyCode:d.Up},b,h);eq(b,"invalid");f({keyCode:d.Up},b,h);eq(b,"map");f({keyCode:d.Up},b,h);eq(b,"sort");f({keyCode:d.Up},b,h);eq(b,"registers");f({keyCode:d.s},"",h);b="s";f({keyCode:d.Up},b,h);eq(b,"sort")},{value:""});testVim("search_clear",function(a,c,f){var e;var b="";var d={Ctrl:17,u:85};a.openDialog=function(i,j,h){e=h.onKeyDown};var g=function(h){if(typeof h=="string"){b=h}};f.doKeys("/");b="foo";e({keyCode:d.Ctrl},b,g);e({keyCode:d.u,ctrlKey:true},b,g);eq(b,"")});testVim("exCommand_clear",function(a,c,f){var e;var b="";var d={Ctrl:17,u:85};a.openDialog=function(i,j,h){e=h.onKeyDown};var g=function(h){if(typeof h=="string"){b=h}};f.doKeys(":");b="foo";e({keyCode:d.Ctrl},b,g);e({keyCode:d.u,ctrlKey:true},b,g);eq(b,"")});testVim(".",function(a,b,c){a.setCursor(0,0);c.doKeys("2","d","w");c.doKeys(".");eq("5 6",a.getValue())},{value:"1 2 3 4 5 6"});testVim("._repeat",function(a,b,c){a.setCursor(0,0);c.doKeys("2","d","w");c.doKeys("3",".");eq("6",a.getValue())},{value:"1 2 3 4 5 6"});testVim("._insert",function(a,b,c){c.doKeys("i");a.replaceRange("test",a.getCursor());c.doKeys("<Esc>");c.doKeys(".");eq("testestt",a.getValue());c.assertCursorAt(0,6)},{value:""});testVim("._insert_repeat",function(a,b,c){c.doKeys("i");a.replaceRange("test",a.getCursor());a.setCursor(0,4);c.doKeys("<Esc>");c.doKeys("2",".");eq("testesttestt",a.getValue());c.assertCursorAt(0,10)},{value:""});testVim("._repeat_insert",function(a,b,c){c.doKeys("3","i");a.replaceRange("te",a.getCursor());a.setCursor(0,2);c.doKeys("<Esc>");c.doKeys(".");eq("tetettetetee",a.getValue());c.assertCursorAt(0,10)},{value:""});testVim("._insert_o",function(a,b,c){c.doKeys("o");a.replaceRange("z",a.getCursor());a.setCursor(1,1);c.doKeys("<Esc>");c.doKeys(".");eq("\nz\nz",a.getValue());c.assertCursorAt(2,0)},{value:""});testVim("._insert_o_repeat",function(a,b,c){c.doKeys("o");a.replaceRange("z",a.getCursor());c.doKeys("<Esc>");a.setCursor(1,0);c.doKeys("2",".");eq("\nz\nz\nz",a.getValue());c.assertCursorAt(3,0)},{value:""});testVim("._insert_o_indent",function(a,b,c){c.doKeys("o");a.replaceRange("z",a.getCursor());c.doKeys("<Esc>");a.setCursor(1,2);c.doKeys(".");eq("{\n  z\n  z",a.getValue());c.assertCursorAt(2,2)},{value:"{"});testVim("._insert_cw",function(a,b,c){c.doKeys("c","w");a.replaceRange("test",a.getCursor());c.doKeys("<Esc>");a.setCursor(0,3);c.doKeys("2","l");c.doKeys(".");eq("test test word3",a.getValue());c.assertCursorAt(0,8)},{value:"word1 word2 word3"});testVim("._insert_cw_repeat",function(a,b,c){c.doKeys("c","w");a.replaceRange("test",a.getCursor());c.doKeys("<Esc>");a.setCursor(0,4);c.doKeys("l");c.doKeys("2",".");eq("test test",a.getValue());c.assertCursorAt(0,8)},{value:"word1 word2 word3"});testVim("._delete",function(a,b,c){a.setCursor(0,5);c.doKeys("i");c.doInsertModeKeys("Backspace");c.doKeys("<Esc>");c.doKeys(".");eq("zace",a.getValue());c.assertCursorAt(0,1)},{value:"zabcde"});testVim("._delete_repeat",function(a,b,c){a.setCursor(0,6);c.doKeys("i");c.doInsertModeKeys("Backspace");c.doKeys("<Esc>");c.doKeys("2",".");eq("zzce",a.getValue());c.assertCursorAt(0,1)},{value:"zzabcde"});testVim("._visual_>",function(a,b,c){a.setCursor(0,0);c.doKeys("V","j",">");a.setCursor(2,0);c.doKeys(".");eq("  1\n  2\n  3\n  4",a.getValue());c.assertCursorAt(2,2)},{value:"1\n2\n3\n4"});testVim("f;",function(a,b,c){a.setCursor(0,0);c.doKeys("f","x");c.doKeys(";");c.doKeys("2",";");eq(9,a.getCursor().ch)},{value:"01x3xx678x"});testVim("F;",function(a,b,c){a.setCursor(0,8);c.doKeys("F","x");c.doKeys(";");c.doKeys("2",";");eq(2,a.getCursor().ch)},{value:"01x3xx6x8x"});testVim("t;",function(a,b,c){a.setCursor(0,0);c.doKeys("t","x");c.doKeys(";");c.doKeys("2",";");eq(8,a.getCursor().ch)},{value:"01x3xx678x"});testVim("T;",function(a,b,c){a.setCursor(0,9);c.doKeys("T","x");c.doKeys(";");c.doKeys("2",";");eq(2,a.getCursor().ch)},{value:"0xx3xx678x"});testVim("f,",function(a,b,c){a.setCursor(0,6);c.doKeys("f","x");c.doKeys(",");c.doKeys("2",",");eq(2,a.getCursor().ch)},{value:"01x3xx678x"});testVim("F,",function(a,b,c){a.setCursor(0,3);c.doKeys("F","x");c.doKeys(",");c.doKeys("2",",");eq(9,a.getCursor().ch)},{value:"01x3xx678x"});testVim("t,",function(a,b,c){a.setCursor(0,6);c.doKeys("t","x");c.doKeys(",");c.doKeys("2",",");eq(3,a.getCursor().ch)},{value:"01x3xx678x"});testVim("T,",function(a,b,c){a.setCursor(0,4);c.doKeys("T","x");c.doKeys(",");c.doKeys("2",",");eq(8,a.getCursor().ch)},{value:"01x3xx67xx"});testVim("fd,;",function(a,b,c){a.setCursor(0,0);c.doKeys("f","4");a.setCursor(0,0);c.doKeys("d",";");eq("56789",a.getValue());c.doKeys("u");a.setCursor(0,9);c.doKeys("d",",");eq("01239",a.getValue())},{value:"0123456789"});testVim("Fd,;",function(a,b,c){a.setCursor(0,9);c.doKeys("F","4");a.setCursor(0,9);c.doKeys("d",";");eq("01239",a.getValue());c.doKeys("u");a.setCursor(0,0);c.doKeys("d",",");eq("56789",a.getValue())},{value:"0123456789"});testVim("td,;",function(a,b,c){a.setCursor(0,0);c.doKeys("t","4");a.setCursor(0,0);c.doKeys("d",";");eq("456789",a.getValue());c.doKeys("u");a.setCursor(0,9);c.doKeys("d",",");eq("012349",a.getValue())},{value:"0123456789"});testVim("Td,;",function(a,b,c){a.setCursor(0,9);c.doKeys("T","4");a.setCursor(0,9);c.doKeys("d",";");eq("012349",a.getValue());c.doKeys("u");a.setCursor(0,0);c.doKeys("d",",");eq("456789",a.getValue())},{value:"0123456789"});testVim("fc,;",function(a,b,c){a.setCursor(0,0);c.doKeys("f","4");a.setCursor(0,0);c.doKeys("c",";","<Esc>");eq("56789",a.getValue());c.doKeys("u");a.setCursor(0,9);c.doKeys("c",",");eq("01239",a.getValue())},{value:"0123456789"});testVim("Fc,;",function(a,b,c){a.setCursor(0,9);c.doKeys("F","4");a.setCursor(0,9);c.doKeys("c",";","<Esc>");eq("01239",a.getValue());c.doKeys("u");a.setCursor(0,0);c.doKeys("c",",");eq("56789",a.getValue())},{value:"0123456789"});testVim("tc,;",function(a,b,c){a.setCursor(0,0);c.doKeys("t","4");a.setCursor(0,0);c.doKeys("c",";","<Esc>");eq("456789",a.getValue());c.doKeys("u");a.setCursor(0,9);c.doKeys("c",",");eq("012349",a.getValue())},{value:"0123456789"});testVim("Tc,;",function(a,b,c){a.setCursor(0,9);c.doKeys("T","4");a.setCursor(0,9);c.doKeys("c",";","<Esc>");eq("012349",a.getValue());c.doKeys("u");a.setCursor(0,0);c.doKeys("c",",");eq("456789",a.getValue())},{value:"0123456789"});testVim("fy,;",function(a,b,c){a.setCursor(0,0);c.doKeys("f","4");a.setCursor(0,0);c.doKeys("y",";","P");eq("012340123456789",a.getValue());c.doKeys("u");a.setCursor(0,9);c.doKeys("y",",","P");eq("012345678456789",a.getValue())},{value:"0123456789"});testVim("Fy,;",function(a,b,c){a.setCursor(0,9);c.doKeys("F","4");a.setCursor(0,9);c.doKeys("y",";","p");eq("012345678945678",a.getValue());c.doKeys("u");a.setCursor(0,0);c.doKeys("y",",","P");eq("012340123456789",a.getValue())},{value:"0123456789"});testVim("ty,;",function(a,b,c){a.setCursor(0,0);c.doKeys("t","4");a.setCursor(0,0);c.doKeys("y",";","P");eq("01230123456789",a.getValue());c.doKeys("u");a.setCursor(0,9);c.doKeys("y",",","p");eq("01234567895678",a.getValue())},{value:"0123456789"});testVim("Ty,;",function(a,b,c){a.setCursor(0,9);c.doKeys("T","4");a.setCursor(0,9);c.doKeys("y",";","p");eq("01234567895678",a.getValue());c.doKeys("u");a.setCursor(0,0);c.doKeys("y",",","P");eq("01230123456789",a.getValue())},{value:"0123456789"});testVim("HML",function(a,c,d){var b=35;var e=a.defaultTextHeight();a.setSize(600,b*e);a.setCursor(120,0);d.doKeys("H");d.assertCursorAt(86,2);d.doKeys("L");d.assertCursorAt(120,4);d.doKeys("M");d.assertCursorAt(103,4)},{value:(function(){var a=new Array(100);var c="  xx\n";var b="    xx\n";c=a.join(c);b=a.join(b);return c+b})()});var zVals=[];forEach(["zb","zz","zt","z-","z.","z<CR>"],function(c,a){var d=250;var b=35;testVim(c,function(e,f,g){var j=c[0];var i=c.substring(1);var h=e.defaultTextHeight();e.setSize(600,b*h);e.setCursor(d,0);g.doKeys(j,i);zVals[a]=e.getScrollInfo().top},{value:(function(){return new Array(500).join("\n")})()})});testVim("zb<zz",function(a,b,c){eq(zVals[0]<zVals[1],true)});testVim("zz<zt",function(a,b,c){eq(zVals[1]<zVals[2],true)});testVim("zb==z-",function(a,b,c){eq(zVals[0],zVals[3])});testVim("zz==z.",function(a,b,c){eq(zVals[1],zVals[4])});testVim("zt==z<CR>",function(a,b,c){eq(zVals[2],zVals[5])});var moveTillCharacterSandbox="The quick brown fox \n";testVim("moveTillCharacter",function(a,b,c){a.setCursor(0,0);a.openDialog=c.fakeOpenDialog("q");c.doKeys("/");eq(4,a.getCursor().ch);c.doKeys("t");c.doKeys("o");eq("The quick brown fox \n",a.getValue());c.doKeys("d");c.doKeys("t");c.doKeys("o");eq("The quick bown fox \n",a.getValue());c.doKeys(".");eq("The quick box \n",a.getValue());c.doKeys("d");c.doKeys("t");c.doKeys("q");eq("The quick box \n",a.getValue());c.doKeys("d");c.doKeys("t");c.doKeys("z");eq("The quick box \n",a.getValue());c.doKeys("d");c.doKeys("N");eq("The ox \n",a.getValue());eq(4,a.getCursor().ch)},{value:moveTillCharacterSandbox});testVim("searchForPipe",function(a,b,c){CodeMirror.Vim.setOption("pcre",false);a.setCursor(0,0);a.openDialog=c.fakeOpenDialog("|");c.doKeys("/");eq(4,a.getCursor().ch)},{value:"this|that"});var scrollMotionSandbox="\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";testVim("scrollMotion",function(a,b,c){var d,e;a.setCursor(0,0);c.doKeys("<C-y>");eq(0,a.getCursor().line);e=a.getScrollInfo();c.doKeys("<C-e>");eq(1,a.getCursor().line);is(e.top<a.getScrollInfo().top);a.setCursor(1000,0);d=a.getCursor();c.doKeys("<C-e>");eq(d.line,a.getCursor().line);e=a.getScrollInfo();c.doKeys("<C-y>");eq(d.line-1,a.getCursor().line,"Y");is(e.top>a.getScrollInfo().top)},{value:scrollMotionSandbox});var squareBracketMotionSandbox="({\n  ({\n  /*comment {\n            */(\n#else                \n  /*       )\n#if        }\n  )}*/\n)}\n{}\n#else {{\n{}\n}\n{\n#endif\n}\n}\n#else";testVim("[[, ]]",function(a,b,c){a.setCursor(0,0);c.doKeys("]","]");c.assertCursorAt(9,0);c.doKeys("2","]","]");c.assertCursorAt(13,0);c.doKeys("]","]");c.assertCursorAt(17,0);c.doKeys("[","[");c.assertCursorAt(13,0);c.doKeys("2","[","[");c.assertCursorAt(9,0);c.doKeys("[","[");c.assertCursorAt(0,0)},{value:squareBracketMotionSandbox});testVim("[], ][",function(a,b,c){a.setCursor(0,0);c.doKeys("]","[");c.assertCursorAt(12,0);c.doKeys("2","]","[");c.assertCursorAt(16,0);c.doKeys("]","[");c.assertCursorAt(17,0);c.doKeys("[","]");c.assertCursorAt(16,0);c.doKeys("2","[","]");c.assertCursorAt(12,0);c.doKeys("[","]");c.assertCursorAt(0,0)},{value:squareBracketMotionSandbox});testVim("[{, ]}",function(a,b,c){a.setCursor(4,10);c.doKeys("[","{");c.assertCursorAt(2,12);c.doKeys("2","[","{");c.assertCursorAt(0,1);a.setCursor(4,10);c.doKeys("]","}");c.assertCursorAt(6,11);c.doKeys("2","]","}");c.assertCursorAt(8,1);a.setCursor(0,1);c.doKeys("]","}");c.assertCursorAt(8,1);c.doKeys("[","{");c.assertCursorAt(0,1)},{value:squareBracketMotionSandbox});testVim("[(, ])",function(a,b,c){a.setCursor(4,10);c.doKeys("[","(");c.assertCursorAt(3,14);c.doKeys("2","[","(");c.assertCursorAt(0,0);a.setCursor(4,10);c.doKeys("]",")");c.assertCursorAt(5,11);c.doKeys("2","]",")");c.assertCursorAt(8,0);c.doKeys("[","(");c.assertCursorAt(0,0);c.doKeys("]",")");c.assertCursorAt(8,0)},{value:squareBracketMotionSandbox});testVim("[*, ]*, [/, ]/",function(a,b,c){forEach(["*","/"],function(d){a.setCursor(7,0);c.doKeys("2","[",d);c.assertCursorAt(2,2);c.doKeys("2","]",d);c.assertCursorAt(7,5)})},{value:squareBracketMotionSandbox});testVim("[#, ]#",function(a,b,c){a.setCursor(10,3);c.doKeys("2","[","#");c.assertCursorAt(4,0);c.doKeys("5","]","#");c.assertCursorAt(17,0);a.setCursor(10,3);c.doKeys("]","#");c.assertCursorAt(14,0)},{value:squareBracketMotionSandbox});testVim("[m, ]m, [M, ]M",function(a,b,c){a.setCursor(11,0);c.doKeys("[","m");c.assertCursorAt(10,7);c.doKeys("4","[","m");c.assertCursorAt(1,3);c.doKeys("5","]","m");c.assertCursorAt(11,0);c.doKeys("[","M");c.assertCursorAt(9,1);c.doKeys("3","]","M");c.assertCursorAt(15,0);c.doKeys("5","[","M");c.assertCursorAt(7,3)},{value:squareBracketMotionSandbox});testVim("ex_go_to_line",function(a,b,c){a.setCursor(0,0);c.doEx("4");c.assertCursorAt(3,0)},{value:"a\nb\nc\nd\ne\n"});testVim("ex_write",function(a,d,g){var f=CodeMirror.commands.save;var c;var b;CodeMirror.commands.save=function(i){c=true;b=i};var h="write";for(var e=1;e<h.length;e++){c=false;b=null;g.doEx(h.substring(0,e));eq(c,true);eq(b,a)}CodeMirror.commands.save=f});testVim("ex_sort",function(a,b,c){c.doEx("sort");eq("Z\na\nb\nc\nd",a.getValue())},{value:"b\nZ\nd\nc\na"});testVim("ex_sort_reverse",function(a,b,c){c.doEx("sort!");eq("d\nc\nb\na",a.getValue())},{value:"b\nd\nc\na"});testVim("ex_sort_range",function(a,b,c){c.doEx("2,3sort");eq("b\nc\nd\na",a.getValue())},{value:"b\nd\nc\na"});testVim("ex_sort_oneline",function(a,b,c){c.doEx("2sort");eq("b\nd\nc\na",a.getValue())},{value:"b\nd\nc\na"});testVim("ex_sort_ignoreCase",function(a,b,c){c.doEx("sort i");eq("a\nb\nc\nd\nZ",a.getValue())},{value:"b\nZ\nd\nc\na"});testVim("ex_sort_unique",function(a,b,c){c.doEx("sort u");eq("Z\na\nb\nc\nd",a.getValue())},{value:"b\nZ\na\na\nd\na\nc\na"});testVim("ex_sort_decimal",function(a,b,c){c.doEx("sort d");eq("d3\n s5\n6\n.9",a.getValue())},{value:"6\nd3\n s5\n.9"});testVim("ex_sort_decimal_negative",function(a,b,c){c.doEx("sort d");eq("z-9\nd3\n s5\n6\n.9",a.getValue())},{value:"6\nd3\n s5\n.9\nz-9"});testVim("ex_sort_decimal_reverse",function(a,b,c){c.doEx("sort! d");eq(".9\n6\n s5\nd3",a.getValue())},{value:"6\nd3\n s5\n.9"});testVim("ex_sort_hex",function(a,b,c){c.doEx("sort x");eq(" s5\n6\n.9\n&0xB\nd3",a.getValue())},{value:"6\nd3\n s5\n&0xB\n.9"});testVim("ex_sort_octal",function(a,b,c){c.doEx("sort o");eq(".8\n.9\nd3\n s5\n6",a.getValue())},{value:"6\nd3\n s5\n.9\n.8"});testVim("ex_sort_decimal_mixed",function(a,b,c){c.doEx("sort d");eq("y\nz\nc1\nb2\na3",a.getValue())},{value:"a3\nz\nc1\ny\nb2"});testVim("ex_sort_decimal_mixed_reverse",function(a,b,c){c.doEx("sort! d");eq("a3\nb2\nc1\nz\ny",a.getValue())},{value:"a3\nz\nc1\ny\nb2"});testVim("ex_sort_patterns_not_supported",function(a,b,c){var d=false;a.openNotification=c.fakeOpenNotification(function(e){d=/patterns not supported/.test(e)});c.doEx("sort /abc/");is(d,"No notification.")});testVim("ex_global",function(a,b,c){a.setCursor(0,0);c.doEx("g/one/s//two");eq("two two\n two two\n two two",a.getValue());c.doEx("1,2g/two/s//one");eq("one one\n one one\n two two",a.getValue())},{value:"one one\n one one\n one one"});testVim("ex_global_confirm",function(a,b,f){a.setCursor(0,0);var d;var c=a.openDialog;var e={a:65,n:78,q:81,y:89};a.openDialog=function(i,j,h){a.openDialog=function(l,m,k){d=k.onKeyDown};j("g/one/s//two/gc")};f.doKeys(":");var g=function(){};d({keyCode:e.n},"",g);d({keyCode:e.y},"",g);d({keyCode:e.a},"",g);d({keyCode:e.q},"",g);d({keyCode:e.y},"",g);eq("one two\n two two\n one one\n two one\n one one",a.getValue())},{value:"one one\n one one\n one one\n one one\n one one"});testVim("ex_substitute_same_line",function(a,b,c){a.setCursor(1,0);c.doEx("s/one/two/g");eq("one one\n two two",a.getValue())},{value:"one one\n one one"});testVim("ex_substitute_full_file",function(a,b,c){a.setCursor(1,0);c.doEx("%s/one/two/g");eq("two two\n two two",a.getValue())},{value:"one one\n one one"});testVim("ex_substitute_input_range",function(a,b,c){a.setCursor(1,0);c.doEx("1,3s/\\d/0/g");eq("0\n0\n0\n4",a.getValue())},{value:"1\n2\n3\n4"});testVim("ex_substitute_visual_range",function(a,b,c){a.setCursor(1,0);c.doKeys("V","2","j","v");c.doEx("'<,'>s/\\d/0/g");eq("1\n0\n0\n0\n5",a.getValue())},{value:"1\n2\n3\n4\n5"});testVim("ex_substitute_empty_query",function(a,b,c){a.setCursor(1,0);a.openDialog=c.fakeOpenDialog("1");c.doKeys("/");c.doEx("s//b/g");eq("abb ab2 ab3",a.getValue())},{value:"a11 a12 a13"});testVim("ex_substitute_javascript",function(a,b,c){CodeMirror.Vim.setOption("pcre",false);a.setCursor(1,0);c.doEx("s/\\(\\d+\\)/$$ $' $` $& \\1/g");eq("a $$ $' $` $& 0 b",a.getValue())},{value:"a 0 b"});testVim("ex_substitute_empty_arguments",function(a,b,c){a.setCursor(0,0);c.doEx("s/a/b/g");a.setCursor(1,0);c.doEx("s");eq("b b\nb a",a.getValue())},{value:"a a\na a"});function testSubstitute(c,b){testVim(c+"_pcre",function(d,e,f){d.setCursor(1,0);CodeMirror.Vim.setOption("pcre",true);f.doEx(b.expr);eq(b.expectedValue,d.getValue())},b);var a=b.noPcreExpr?b.noPcreExpr:b.expr;testVim(c+"_nopcre",function(d,e,f){d.setCursor(1,0);CodeMirror.Vim.setOption("pcre",false);f.doEx(a);eq(b.expectedValue,d.getValue())},b)}testSubstitute("ex_substitute_capture",{value:"a11 a12 a13",expectedValue:"a1111 a1212 a1313",expr:"s/(\\d+)/$1$1/g",noPcreExpr:"s/\\(\\d+\\)/\\1\\1/g"});testSubstitute("ex_substitute_capture2",{value:"a 0 b",expectedValue:"a $00 b",expr:"s/(\\d+)/$$$1$1/g",noPcreExpr:"s/\\(\\d+\\)/$\\1\\1/g"});testSubstitute("ex_substitute_nocapture",{value:"a11 a12 a13",expectedValue:"a$1$1 a$1$1 a$1$1",expr:"s/(\\d+)/$$1$$1/g",noPcreExpr:"s/\\(\\d+\\)/$1$1/g"});testSubstitute("ex_substitute_nocapture2",{value:"a 0 b",expectedValue:"a $10 b",expr:"s/(\\d+)/$$1$1/g",noPcreExpr:"s/\\(\\d+\\)/\\$1\\1/g"});testSubstitute("ex_substitute_nocapture",{value:"a b c",expectedValue:"a $ c",expr:"s/b/$$/",noPcreExpr:"s/b/$/"});testSubstitute("ex_substitute_slash_regex",{value:"one/two \n three/four",expectedValue:"one|two \n three|four",expr:"%s/\\//|"});testSubstitute("ex_substitute_pipe_regex",{value:"one|two \n three|four",expectedValue:"one,two \n three,four",expr:"%s/\\|/,/",noPcreExpr:"%s/|/,/"});testSubstitute("ex_substitute_or_regex",{value:"one|two \n three|four",expectedValue:"ana|twa \n thraa|faar",expr:"%s/o|e|u/a/g",noPcreExpr:"%s/o\\|e\\|u/a/g"});testSubstitute("ex_substitute_or_word_regex",{value:"one|two \n three|four",expectedValue:"five|five \n three|four",expr:"%s/(one|two)/five/g",noPcreExpr:"%s/\\(one\\|two\\)/five/g"});testSubstitute("ex_substitute_backslashslash_regex",{value:"one\\two \n three\\four",expectedValue:"one,two \n three,four",expr:"%s/\\\\/,"});testSubstitute("ex_substitute_slash_replacement",{value:"one,two \n three,four",expectedValue:"one/two \n three/four",expr:"%s/,/\\/"});testSubstitute("ex_substitute_backslash_replacement",{value:"one,two \n three,four",expectedValue:"one\\two \n three\\four",expr:"%s/,/\\\\/g"});testSubstitute("ex_substitute_multibackslash_replacement",{value:"one,two \n three,four",expectedValue:"one\\\\\\\\two \n three\\\\\\\\four",expr:"%s/,/\\\\\\\\\\\\\\\\/g"});testSubstitute("ex_substitute_newline_replacement",{value:"one,two \n three,four",expectedValue:"one\ntwo \n three\nfour",expr:"%s/,/\\n/g"});testSubstitute("ex_substitute_braces_word",{value:"ababab abb ab{2}",expectedValue:"ab abb ab{2}",expr:"%s/(ab){2}//g",noPcreExpr:"%s/\\(ab\\)\\{2\\}//g"});testSubstitute("ex_substitute_braces_range",{value:"a aa aaa aaaa",expectedValue:"a   a",expr:"%s/a{2,3}//g",noPcreExpr:"%s/a\\{2,3\\}//g"});testSubstitute("ex_substitute_braces_literal",{value:"ababab abb ab{2}",expectedValue:"ababab abb ",expr:"%s/ab\\{2\\}//g",noPcreExpr:"%s/ab{2}//g"});testSubstitute("ex_substitute_braces_char",{value:"ababab abb ab{2}",expectedValue:"ababab  ab{2}",expr:"%s/ab{2}//g",noPcreExpr:"%s/ab\\{2\\}//g"});testSubstitute("ex_substitute_braces_no_escape",{value:"ababab abb ab{2}",expectedValue:"ababab  ab{2}",expr:"%s/ab{2}//g",noPcreExpr:"%s/ab\\{2}//g"});testSubstitute("ex_substitute_count",{value:"1\n2\n3\n4",expectedValue:"1\n0\n0\n4",expr:"s/\\d/0/i 2"});testSubstitute("ex_substitute_count_with_range",{value:"1\n2\n3\n4",expectedValue:"1\n2\n0\n0",expr:"1,3s/\\d/0/ 3"});testSubstitute("ex_substitute_not_global",{value:"aaa\nbaa\ncaa",expectedValue:"xaa\nbxa\ncxa",expr:"%s/a/x/"});function testSubstituteConfirm(c,f,a,b,d,e){testVim(c,function(q,j,g){var p=q.openDialog;var h=CodeMirror.keyName;var n;var o;var l=true;function r(){l=true}q.openDialog=function(s,t,i){o=t};g.doKeys(":");q.openDialog=function(s,t,i){n=i.onKeyDown;l=false};o(f);CodeMirror.keyName=function(i){return i.key};d=d.toUpperCase();for(var k=0;k<d.length;k++){is(!l);n({key:d.charAt(k)},"",r)}try{eq(b,q.getValue());g.assertCursorAt(e);is(l)}catch(m){throw m}finally{CodeMirror.keyName=h;q.openDialog=p}},{value:a})}testSubstituteConfirm("ex_substitute_confirm_emptydoc","%s/x/b/c","","","",makeCursor(0,0));testSubstituteConfirm("ex_substitute_confirm_nomatch","%s/x/b/c","ba a\nbab","ba a\nbab","",makeCursor(0,0));testSubstituteConfirm("ex_substitute_confirm_accept","%s/a/b/cg","ba a\nbab","bb b\nbbb","yyy",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_random_keys","%s/a/b/cg","ba a\nbab","bb b\nbbb","ysdkywerty",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_some","%s/a/b/cg","ba a\nbab","bb a\nbbb","yny",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_all","%s/a/b/cg","ba a\nbab","bb b\nbbb","a",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_accept_then_all","%s/a/b/cg","ba a\nbab","bb b\nbbb","ya",makeCursor(1,1));testSubstituteConfirm("ex_substitute_confirm_quit","%s/a/b/cg","ba a\nbab","bb a\nbab","yq",makeCursor(0,3));testSubstituteConfirm("ex_substitute_confirm_last","%s/a/b/cg","ba a\nbab","bb b\nbab","yl",makeCursor(0,3));testSubstituteConfirm("ex_substitute_confirm_oneline","1s/a/b/cg","ba a\nbab","bb b\nbab","yl",makeCursor(0,3));testSubstituteConfirm("ex_substitute_confirm_range_accept","1,2s/a/b/cg","aa\na \na\na","bb\nb \na\na","yyy",makeCursor(1,0));testSubstituteConfirm("ex_substitute_confirm_range_some","1,3s/a/b/cg","aa\na \na\na","ba\nb \nb\na","ynyy",makeCursor(2,0));testSubstituteConfirm("ex_substitute_confirm_range_all","1,3s/a/b/cg","aa\na \na\na","bb\nb \nb\na","a",makeCursor(2,0));testSubstituteConfirm("ex_substitute_confirm_range_last","1,3s/a/b/cg","aa\na \na\na","bb\nb \na\na","yyl",makeCursor(1,0));testVim("ex_noh_clearSearchHighlight",function(a,b,c){a.openDialog=c.fakeOpenDialog("match");c.doKeys("?");c.doEx("noh");eq(b.searchState_.getOverlay(),null,"match-highlighting wasn't cleared");c.doKeys("n");c.assertCursorAt(0,11,"can't resume search after clearing highlighting")},{value:"match nope match \n nope Match"});testVim("set_boolean",function(a,b,d){CodeMirror.Vim.defineOption("testoption",true,"boolean");is(CodeMirror.Vim.getOption("testoption"));try{CodeMirror.Vim.setOption("testoption","5");fail()}catch(c){}CodeMirror.Vim.setOption("testoption",false);is(!CodeMirror.Vim.getOption("testoption"))});testVim("ex_set_boolean",function(a,b,d){CodeMirror.Vim.defineOption("testoption",true,"boolean");is(CodeMirror.Vim.getOption("testoption"));try{d.doEx("set testoption=22");fail()}catch(c){}d.doEx("set notestoption");is(!CodeMirror.Vim.getOption("testoption"))});testVim("set_string",function(a,b,d){CodeMirror.Vim.defineOption("testoption","a","string");eq("a",CodeMirror.Vim.getOption("testoption"));try{CodeMirror.Vim.setOption("testoption",true);fail()}catch(c){}try{CodeMirror.Vim.setOption("notestoption","b");fail()}catch(c){}CodeMirror.Vim.setOption("testoption","c");eq("c",CodeMirror.Vim.getOption("testoption"))});testVim("ex_set_string",function(a,b,d){CodeMirror.Vim.defineOption("testopt","a","string");eq("a",CodeMirror.Vim.getOption("testopt"));try{d.doEx("set notestopt=b");fail()}catch(c){}d.doEx("set testopt=c");eq("c",CodeMirror.Vim.getOption("testopt"));d.doEx("set testopt=c");eq("c",CodeMirror.Vim.getOption("testopt",a));eq("c",CodeMirror.Vim.getOption("testopt",a,{scope:"local"}));eq("c",CodeMirror.Vim.getOption("testopt",a,{scope:"global"}));eq("c",CodeMirror.Vim.getOption("testopt"));d.doEx("setg testopt=d");eq("c",CodeMirror.Vim.getOption("testopt",a));eq("c",CodeMirror.Vim.getOption("testopt",a,{scope:"local"}));eq("d",CodeMirror.Vim.getOption("testopt",a,{scope:"global"}));eq("d",CodeMirror.Vim.getOption("testopt"));d.doEx("setl testopt=e");eq("e",CodeMirror.Vim.getOption("testopt",a));eq("e",CodeMirror.Vim.getOption("testopt",a,{scope:"local"}));eq("d",CodeMirror.Vim.getOption("testopt",a,{scope:"global"}));eq("d",CodeMirror.Vim.getOption("testopt"))});testVim("ex_set_callback",function(b,c,f){var e;function a(i,g,h){if(i===undefined){if(g){return g._local}else{return e}}else{if(g){g._local=i}else{e=i}}}CodeMirror.Vim.defineOption("testopt","a","string",a);eq("a",CodeMirror.Vim.getOption("testopt"));try{f.doEx("set notestopt=b");fail()}catch(d){}f.doEx("set testopt=c");eq("c",CodeMirror.Vim.getOption("testopt",b));eq("c",CodeMirror.Vim.getOption("testopt",b,{scope:"local"}));eq("c",CodeMirror.Vim.getOption("testopt",b,{scope:"global"}));eq("c",CodeMirror.Vim.getOption("testopt"));f.doEx("setg testopt=d");eq("c",CodeMirror.Vim.getOption("testopt",b));eq("c",CodeMirror.Vim.getOption("testopt",b,{scope:"local"}));eq("d",CodeMirror.Vim.getOption("testopt",b,{scope:"global"}));eq("d",CodeMirror.Vim.getOption("testopt"));f.doEx("setl testopt=e");eq("e",CodeMirror.Vim.getOption("testopt",b));eq("e",CodeMirror.Vim.getOption("testopt",b,{scope:"local"}));eq("d",CodeMirror.Vim.getOption("testopt",b,{scope:"global"}));eq("d",CodeMirror.Vim.getOption("testopt"))});testVim("ex_set_filetype",function(a,b,c){CodeMirror.defineMode("test_mode",function(){return{token:function(d){d.match(/^\s+|^\S+/)}}});CodeMirror.defineMode("test_mode_2",function(){return{token:function(d){d.match(/^\s+|^\S+/)}}});c.doEx("set filetype=test_mode");eq("test_mode",a.getMode().name);c.doEx("set ft=test_mode_2");eq("test_mode_2",a.getMode().name)});testVim("ex_set_filetype_null",function(a,b,c){CodeMirror.defineMode("test_mode",function(){return{token:function(d){d.match(/^\s+|^\S+/)}}});a.setOption("mode","test_mode");c.doEx("set filetype=");eq("null",a.getMode().name)});testVim("ex_map_key2key",function(a,b,c){c.doEx("map a x");c.doKeys("a");c.assertCursorAt(0,0);eq("bc",a.getValue())},{value:"abc"});testVim("ex_unmap_key2key",function(a,b,c){c.doEx("unmap a");c.doKeys("a");eq("vim-insert",a.getOption("keyMap"))},{value:"abc"});testVim("ex_unmap_key2key_does_not_remove_default",function(a,b,d){try{d.doEx("unmap a");fail()}catch(c){}d.doKeys("a");eq("vim-insert",a.getOption("keyMap"))},{value:"abc"});testVim("ex_map_key2key_to_colon",function(a,c,d){d.doEx("map ; :");var b=false;a.openDialog=function(){b=true};d.doKeys(";");eq(b,true)});testVim("ex_map_ex2key:",function(a,b,c){c.doEx("map :del x");c.doEx("del");c.assertCursorAt(0,0);eq("bc",a.getValue())},{value:"abc"});testVim("ex_map_ex2ex",function(a,d,f){f.doEx("map :del :w");var e=CodeMirror.commands.save;var c=false;var b;CodeMirror.commands.save=function(g){c=true;b=g};f.doEx("del");CodeMirror.commands.save=e;eq(c,true);eq(b,a)});testVim("ex_map_key2ex",function(a,d,f){f.doEx("map a :w");var e=CodeMirror.commands.save;var c=false;var b;CodeMirror.commands.save=function(g){c=true;b=g};f.doKeys("a");CodeMirror.commands.save=e;eq(c,true);eq(b,a)});testVim("ex_map_key2key_visual_api",function(a,d,f){CodeMirror.Vim.map("b",":w","visual");var e=CodeMirror.commands.save;var c=false;var b;CodeMirror.commands.save=function(g){c=true;b=g};f.doKeys("b");eq(c,false);f.doKeys("v","b");eq(c,true);eq(b,a);CodeMirror.commands.save=e});testVim("ex_imap",function(a,b,c){CodeMirror.Vim.map("jk","<Esc>","insert");c.doKeys("i");is(b.insertMode);c.doKeys("j","k");is(!b.insertMode)});testVim("ex_api_test",function(a,b,d){var c=false;var e="from";CodeMirror.Vim.defineEx("extest","ext",function(f,g){if(g.args){e=g.args[0]}else{c=true}});d.doEx(":ext to");eq(e,"to","Defining ex-command failed");CodeMirror.Vim.map("<C-CR><Space>",":ext");d.doKeys("<C-CR>","<Space>");is(c,"Mapping to key failed")});testVim("ex_map_key2key_from_colon",function(a,b,c){c.doEx("map : x");c.doKeys(":");c.assertCursorAt(0,0);eq("bc",a.getValue())},{value:"abc"});testVim("beforeSelectionChange",function(a,b,c){a.setCursor(0,100);eqPos(a.getCursor("head"),a.getCursor("anchor"))},{value:"abc"});