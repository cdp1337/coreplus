// jQuery UI Nested Sortable
// v 1.4 / 30 dec 2011
(function(a){a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",listType:"ol",maxLevels:0,protectRoot:false,rootID:null,rtl:false,isAllowed:function(c,b){return true},},_create:function(){this.element.data("sortable",this.element.data("nestedSortable"));if(!this.element.is(this.options.listType)){throw new Error("nestedSortable: Please check the listType option is set to your actual list type")}return a.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){this.element.removeData("nestedSortable").unbind(".nestedSortable");return a.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(d){this.position=this._generatePosition(d);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var g=this.options,e=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-d.pageY<g.scrollSensitivity){this.scrollParent[0].scrollTop=e=this.scrollParent[0].scrollTop+g.scrollSpeed}else{if(d.pageY-this.overflowOffset.top<g.scrollSensitivity){this.scrollParent[0].scrollTop=e=this.scrollParent[0].scrollTop-g.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-d.pageX<g.scrollSensitivity){this.scrollParent[0].scrollLeft=e=this.scrollParent[0].scrollLeft+g.scrollSpeed}else{if(d.pageX-this.overflowOffset.left<g.scrollSensitivity){this.scrollParent[0].scrollLeft=e=this.scrollParent[0].scrollLeft-g.scrollSpeed}}}else{if(d.pageY-a(document).scrollTop()<g.scrollSensitivity){e=a(document).scrollTop(a(document).scrollTop()-g.scrollSpeed)}else{if(a(window).height()-(d.pageY-a(document).scrollTop())<g.scrollSensitivity){e=a(document).scrollTop(a(document).scrollTop()+g.scrollSpeed)}}if(d.pageX-a(document).scrollLeft()<g.scrollSensitivity){e=a(document).scrollLeft(a(document).scrollLeft()-g.scrollSpeed)}else{if(a(window).width()-(d.pageX-a(document).scrollLeft())<g.scrollSensitivity){e=a(document).scrollLeft(a(document).scrollLeft()+g.scrollSpeed)}}}if(e!==false&&a.ui.ddmanager&&!g.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,d)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}for(var m=this.items.length-1;m>=0;m--){var n=this.items[m],h=n.item[0],c=this._intersectsWithPointer(n);if(!c){continue}if(h!=this.currentItem[0]&&this.placeholder[c==1?"next":"prev"]()[0]!=h&&!a.contains(this.placeholder[0],h)&&(this.options.type=="semi-dynamic"?!a.contains(this.element[0],h):true)){a(h).mouseenter();this.direction=c==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(n)){a(h).mouseleave();this._rearrange(d,n)}else{break}this._clearEmpty(h);this._trigger("change",d,this._uiHash());break}}var j=(this.placeholder[0].parentNode.parentNode&&a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length)?a(this.placeholder[0].parentNode.parentNode):null,b=this._getLevel(this.placeholder),k=this._getChildLevels(this.helper),l=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(l!=null){while(l[0].nodeName.toLowerCase()!="li"||l[0]==this.currentItem[0]){if(l[0].previousSibling){l=a(l[0].previousSibling)}else{l=null;break}}}var f=document.createElement(g.listType);this.beyondMaxLevels=0;if(j!=null&&(g.rtl&&(this.positionAbs.left+this.helper.outerWidth()>j.offset().left+j.outerWidth())||!g.rtl&&(this.positionAbs.left<j.offset().left))){j.after(this.placeholder[0]);this._clearEmpty(j[0]);this._trigger("change",d,this._uiHash())}else{if(l!=null&&(g.rtl&&(this.positionAbs.left+this.helper.outerWidth()<l.offset().left+l.outerWidth()-g.tabSize)||!g.rtl&&(this.positionAbs.left>l.offset().left+g.tabSize))){this._isAllowed(l,b,b+k+1);if(!l.children(g.listType).length){l[0].appendChild(f)}l.children(g.listType)[0].appendChild(this.placeholder[0]);this._trigger("change",d,this._uiHash())}else{this._isAllowed(j,b,b+k)}}this._contactContainers(d);if(a.ui.ddmanager){a.ui.ddmanager.drag(this,d)}this._trigger("sort",d,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(d,e){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){a(this.domPosition.prev).after(this.placeholder)}else{a(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",d,this._uiHash())}for(var b=this.items.length-1;b>=0;b--){var c=this.items[b].item[0];this._clearEmpty(c)}a.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(c){var e=a.extend({},this.options,c),b=this._getItemsAsjQuery(e&&e.connected),d=[];a(b).each(function(){var g=(a(e.item||this).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/)),f=(a(e.item||this).parent(e.listType).parent(e.items).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/));if(g){d.push((e.key||g[1]+"["+(e.key&&e.expression?g[1]:g[2])+"]")+"="+(f?(e.key&&e.expression?f[1]:f[2]):e.rootID))}});if(!d.length&&e.key){d.push(e.key+"=")}return d.join("&")},toHierarchy:function(e){var f=a.extend({},this.options,e),c=f.startDepthCount||0,d=[];a(this.element).children(f.items).each(function(){var g=b(this);d.push(g)});return d;function b(h){var i=(a(h).attr(f.attribute||"id")||"").match(f.expression||(/(.+)[-=_](.+)/));if(i){var g={id:i[2]};if(a(h).children(f.listType).children(f.items).length>0){g.children=[];a(h).children(f.listType).children(f.items).each(function(){var j=b(this);g.children.push(j)})}return g}}},toArray:function(d){var g=a.extend({},this.options,d),b=g.startDepthCount||0,c=[],e=2;c.push({item_id:g.rootID,parent_id:"none",depth:b,left:"1",right:(a(g.items,this.element).length+1)*2});a(this.element).children(g.items).each(function(){e=f(this,b+1,e)});c=c.sort(function(i,h){return(i.left-h.left)});return c;function f(k,m,l){var j=l+1,n,i;if(a(k).children(g.listType).children(g.items).length>0){m++;a(k).children(g.listType).children(g.items).each(function(){j=f(a(this),m,j)});m--}n=(a(k).attr(g.attribute||"id")).match(g.expression||(/(.+)[-=_](.+)/));if(m===b+1){i=g.rootID}else{var h=(a(k).parent(g.listType).parent(g.items).attr(g.attribute||"id")).match(g.expression||(/(.+)[-=_](.+)/));i=h[2]}if(n){c.push({item_id:n[2],parent_id:i,depth:m,left:l,right:j})}l=j+1;return l}},_clearEmpty:function(b){var c=a(b).children(this.options.listType);if(c.length&&!c.children().length){c.remove()}},_getLevel:function(b){var d=1;if(this.options.listType){var c=b.closest(this.options.listType);while(!c.is(".ui-sortable")){d++;c=c.parent().closest(this.options.listType)}}return d},_getChildLevels:function(d,f){var c=this,e=this.options,b=0;f=f||0;a(d).children(e.listType).children(e.items).each(function(g,h){b=Math.max(c._getChildLevels(h,f+1),b)});return f?b+1:b},_isAllowed:function(b,f,d){var e=this.options,c=a(this.domPosition.parent).hasClass("ui-sortable")?true:false;if(!e.isAllowed(b,this.placeholder)||b&&b.hasClass(e.disableNesting)||e.protectRoot&&(b==null&&!c||c&&f>1)){this.placeholder.addClass(e.errorClass);if(e.maxLevels<d&&e.maxLevels!=0){this.beyondMaxLevels=d-e.maxLevels}else{this.beyondMaxLevels=1}}else{if(e.maxLevels<d&&e.maxLevels!=0){this.placeholder.addClass(e.errorClass);this.beyondMaxLevels=d-e.maxLevels}else{this.placeholder.removeClass(e.errorClass);this.beyondMaxLevels=0}}}}));a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)})(jQuery);