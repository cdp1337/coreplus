// Created with JetBrains PhpStorm.
Updater={};(function(e){var g=null,f,b,d,c=null,a=false;Updater.PerformCheck=function(h){if(h){h.html("Checking for updates...")}e.ajax({url:Core.ROOT_WDIR+"updater/check.json",type:"get",dataType:"json",success:function(i){if(i||a){if(h){h.html("Updates Available!")}f()}else{if(h){h.html("No updates available")}}},error:function(){if(h){h.html("An error occurred while checking for updates.")}}})};Updater.GetPackages=function(h){if(!h){h=e("#updates")}h.html("Loading Packages...");e.ajax({url:Core.ROOT_WDIR+"updater/getupdates.json",type:"get",dataType:"json",success:function(i){c=i;drawpackages();h.html("")},error:function(){h.html("Unable to retrieve list of packages")}})};f=function(){e.ajax({url:Core.ROOT_WDIR+"updater/getupdates.json?onlyupdates=1",type:"get",dataType:"json",success:function(h){c=h;b();if(e("#update-everything-wrapper").length){e("#update-everything-wrapper").show()}},error:function(){}})};b=function(){var h=e("#component-list"),l=e("#theme-list"),k=e("#core-list"),j,m;if(!c){return}e(".update-link").hide();if(a){m=k.find(".update-link");m.html("Update to 99.1337 (test)").show();m.data("version","99.1337~(test)").data("type","core").data("name","core")}for(j in c.components){m=h.find('tr[data-type=components][data-name="'+j+'"]').find(".update-link");m.html("Update to "+c.components[j].version).show();m.data("version",c.components[j].version).data("type","components").data("name",c.components[j].name)}for(j in c.themes){m=l.find('tr[data-type=themes][data-name="'+j+'"]').find(".update-link");m.html("Update to "+c.themes[j].version).show();m.data("version",c.themes[j].version).data("type","themes").data("name",c.themes[j].name)}if(typeof c.core!="undefined"&&c.core){m=k.find(".update-link");m.html("Update to "+c.core.version).show();m.data("version",c.core.version).data("type","core").data("name","core")}};drawpackages=function(){var m=e("#component-list"),n=e("#theme-list"),l=e("#core-list"),j,i,o,k,h;h=0;for(j in c.components){o=c.components[j];i=o.version;if(o.status==="downgrade"){continue}k="<tr><td>"+o.title+"</td><td>"+i+"</td>";if(o.status==="installed"){continue}else{if(o.status==="new"){k+='<td><a href="#" class="perform-update" type="components" name="'+j+'" version="'+i+'">Install</a></td>'}else{if(o.status==="update"){continue}else{k+="<td>"+o.status+"</td>"}}}k+="</tr>";m.append(k);++h}if(h===0){m.append('<tr><td colspan="3">No new components available</td></tr>')}h=0;for(j in c.themes){o=c.themes[j];i=o.version;if(o.status==="downgrade"){continue}k="<tr><td>"+o.title+"</td><td>"+i+"</td>";if(o.status==="installed"){continue}else{if(o.status==="new"){k+='<td><a href="#" class="perform-update" type="themes" name="'+j+'" version="'+i+'">Install</a></td>'}else{if(o.status==="update"){continue}else{k+="<td>"+o.status+"</td>"}}}k+="</tr>";n.append(k);++h}if(h===0){n.append('<tr><td colspan="3">No new themes available</td></tr>')}};d=function(m,l,h){var k,n=e("#update-terminal"),j,i;if(g!==null){g.abort()}switch(m){case"components":k=Core.ROOT_WDIR+"updater/component/install/"+l+"?version="+h;break;case"themes":k=Core.ROOT_WDIR+"updater/theme/install/"+l+"?version="+h;break;case"core":k=Core.ROOT_WDIR+"updater/core/install?version="+h;break;default:alert("Invalid type, "+m);return false}if(n.find("iframe").length){j=e("#terminal");i=n.find("form");i.attr("action",k+"&verbose=1")}else{j=e('<iframe name="terminal" id="terminal"></iframe>');i=e('<form action="'+k+'&verbose=1" method="POST" target="terminal"></form>');j.on("load",function(){var p=e(this).contents().find("body"),o=p.find("#results");if(o.attr("status")=="1"){p.append("Executing Core installer...<br/>\n");e.ajax({url:Core.ROOT_URL+"admin/reinstallall",success:function(){p.append("Re-executing Core installer (yes, I am calling it twice)...<br/>\n");e.ajax({url:Core.ROOT_URL+"admin/reinstallall",success:function(){p.append("Installation successful!");f()},error:function(){p.append("Installation probably successful...");f()}})},error:function(){p.append("Re-executing Core installer (yes, I am calling it twice)...<br/>\n");e.ajax({url:Core.ROOT_URL+"admin/reinstallall",success:function(){p.append("Installation successful!");f()},error:function(){p.append("Installation probably successful...");f()}})}})}else{p.append("Seems that an error occurred.  Aborting installation!<br/>\n");alert(o.html())}});n.append(j).append(i)}j.html("Starting installation...");n.show();i.submit();return false};e(function(){e(".disable-link, .enable-link").click(function(){var k=e(this),i=k.closest("tr"),h=i.data("name"),j=(k.text()==="Enable")?"enable":"disable";if(g!==null){g.abort()}g=e.ajax({url:Core.ROOT_WDIR+"updater/component/"+j+"/"+h+"?dryrun=1",type:"POST",dataType:"json",success:function(l){if(l.message){alert(l.message);return}if((l.changes.length>1&&confirm("The following components will be "+j+"d: \n\n"+l.changes.join("\n")))||(l.changes.length===1)){g=e.ajax({url:Core.ROOT_WDIR+"updater/component/"+j+"/"+h+"?dryrun=0",type:"POST",dataType:"json",success:function(m){Core.Reload()},error:function(o,n,m){alert(m)}})}},error:function(n,m,l){alert(l)}});return false});e("body").delegate(".perform-update","click",function(){var l=e(this),j=l.data("name"),h=l.data("version"),k=l.data("type"),i=null;if(g!==null){g.abort()}switch(k){case"components":i=Core.ROOT_WDIR+"updater/component/install/"+j+"?version="+h;break;case"themes":i=Core.ROOT_WDIR+"updater/theme/install/"+j+"?version="+h;break;case"core":i=Core.ROOT_WDIR+"updater/core/install?version="+h;break;default:alert("Invalid type, "+k);return false}if(!l.data("original-text")){l.data("original-text",l.text())}l.html(e("#loading-replacement-text").html());g=e.ajax({url:i+"&dryrun=1",type:"POST",dataType:"json",success:function(m){var n="";if(!m.status){l.html(l.data("original-text"));l.removeAttr("original-text");alert(m.message);return}if(m.changes&&m.changes.length>1){n="The following additional changes will take place: \n\n"+m.changes.join("\n")+"\n\nClick ok to proceed with the upgrade/install."}else{n="Everything looks good, click ok to proceed with the upgrade/install."}l.html(l.data("original-text"));l.removeAttr("original-text");if(confirm(n)){d(k,j,h)}},error:function(o,n,m){l.html(l.data("original-text"));l.removeAttr("original-text");alert(m)}});return false})})})(jQuery);